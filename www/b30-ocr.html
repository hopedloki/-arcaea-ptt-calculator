<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B30 å›¾ç‰‡ OCR åˆ†æå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f9f9f9;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f0f0ff;
        }
        
        .upload-area.active {
            border-color: #667eea;
            background-color: #e8e8ff;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .preview-container {
            display: none;
            margin: 20px 0;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .process-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: none;
            margin: 10px auto;
        }
        
        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .result-container {
            display: none;
        }
        
        .result-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .song-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .song-table th, .song-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .song-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #555;
        }
        
        .song-table tr:hover {
            background-color: #f5f5ff;
        }
        
        .raw-text {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .error {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">â† è¿”å› PTT è®¡ç®—å™¨</a>
        
        <div class="header">
            <h1>ğŸµ Arcaea B30 å›¾ç‰‡ OCR åˆ†æå™¨</h1>
            <p>ä¸Šä¼  B30 æˆç»©æˆªå›¾ï¼Œè‡ªåŠ¨æå–æ­Œæ›²å®šæ•°å’Œ PTT ä¿¡æ¯</p>
        </div>
        
        <div class="card">
            <div class="upload-area" id="uploadArea">
                <div>
                    <h3>ğŸ“· ä¸Šä¼  B30 æˆç»©æˆªå›¾</h3>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®ä½¿ç”¨æ¸…æ™°çš„æ¸¸æˆæˆªå›¾
                    </p>
                </div>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            
            <div class="preview-container" id="previewContainer">
                <h3>é¢„è§ˆå›¾ç‰‡ï¼š</h3>
                <img class="preview-image" id="previewImage" alt="B30 æˆç»©æˆªå›¾">
                <div style="text-align: center;">
                    <button class="process-btn" id="processBtn">ğŸ” å¼€å§‹ OCR è¯†åˆ«</button>
                    <button class="process-btn" id="resetBtn" style="display: none;">ğŸ”„ é‡æ–°ä¸Šä¼ </button>
                </div>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress" id="progress"></div>
            </div>
            
            <div class="status" id="status"></div>
        </div>
        
        <div class="card result-container" id="resultContainer">
            <div class="result-tabs">
                <div class="tab active" data-tab="parsed">ğŸ“Š è§£æç»“æœ</div>
                <div class="tab" data-tab="raw">ğŸ“ åŸå§‹æ–‡æœ¬</div>
                <div class="tab" data-tab="stats">ğŸ“ˆ ç»Ÿè®¡åˆ†æ</div>
            </div>
            
            <div class="tab-content active" id="parsed">
                <h3>ğŸµ B30 æ­Œæ›²åˆ—è¡¨</h3>
                <table class="song-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>æ­Œæ›²åç§°</th>
                            <th>éš¾åº¦</th>
                            <th>å®šæ•°</th>
                            <th>åˆ†æ•°</th>
                            <th>å•æ›² PTT</th>
                        </tr>
                    </thead>
                    <tbody id="songTableBody">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="raw">
                <h3>ğŸ“ OCR è¯†åˆ«çš„åŸå§‹æ–‡æœ¬</h3>
                <div class="raw-text" id="rawText">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
            </div>
            
            <div class="tab-content" id="stats">
                <h3>ğŸ“ˆ B30 ç»Ÿè®¡åˆ†æ</h3>
                <div class="stats-grid" id="statsGrid">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const processBtn = document.getElementById('processBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const status = document.getElementById('status');
        const resultContainer = document.getElementById('resultContainer');
        
        let uploadedImage = null;
        
        // äº‹ä»¶ç›‘å¬å™¨
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('active');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('active');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('active');
            
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        processBtn.addEventListener('click', processImage);
        resetBtn.addEventListener('click', resetUpload);
        
        // Tab åˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // æ›´æ–° tab çŠ¶æ€
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // æ›´æ–°å†…å®¹æ˜¾ç¤º
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');
            });
        });
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showStatus('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œé™åˆ¶åœ¨5MBä»¥å†…
            if (file.size > 5 * 1024 * 1024) {
                showStatus('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä½¿ç”¨å°äº5MBçš„å›¾ç‰‡ä»¥åŠ å¿«å¤„ç†é€Ÿåº¦ï¼', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = e.target.result;
                previewImage.src = uploadedImage;
                uploadArea.style.display = 'none';
                previewContainer.style.display = 'block';
                processBtn.style.display = 'inline-block';
                showStatus('å›¾ç‰‡å·²åŠ è½½ï¼Œç‚¹å‡»"å¼€å§‹ OCR è¯†åˆ«"æŒ‰é’®å¼€å§‹åˆ†æ', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        // å›¾ç‰‡é¢„å¤„ç†ä»¥æé«˜OCRé€Ÿåº¦å’Œå‡†ç¡®ç‡
        async function preprocessImage(imageSrc) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ç¼©å°å›¾ç‰‡ä»¥æé«˜å¤„ç†é€Ÿåº¦
                    const maxWidth = 1200;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    
                    // ç»˜åˆ¶å¹¶åº”ç”¨å¯¹æ¯”åº¦å¢å¼º
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // å¢å¼ºå¯¹æ¯”åº¦ï¼Œä½¿æ–‡å­—æ›´æ¸…æ™°
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        // å¢å¼ºå¯¹æ¯”åº¦
                        data[i] = Math.min(255, data[i] * 1.2);     // R
                        data[i + 1] = Math.min(255, data[i + 1] * 1.2); // G
                        data[i + 2] = Math.min(255, data[i + 2] * 1.2); // B
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    const processedSrc = canvas.toDataURL('image/jpeg', 0.8);
                    resolve(processedSrc);
                };
                img.src = imageSrc;
            });
        }
        
        // å¤„ç†å›¾ç‰‡ OCR
        async function processImage() {
            if (!uploadedImage) return;
            
            // æ˜¾ç¤ºè¿›åº¦æ¡å’ŒçŠ¶æ€
            processBtn.disabled = true;
            processBtn.innerHTML = '<span class="loading-spinner"></span>æ­£åœ¨å¤„ç†...';
            progressBar.style.display = 'block';
            showStatus('æ­£åœ¨é¢„å¤„ç†å›¾ç‰‡...', 'info');
            updateProgress(10);
            
            // é¢„å¤„ç†å›¾ç‰‡
            const processedImage = await preprocessImage(uploadedImage);
            showStatus('æ­£åœ¨åˆå§‹åŒ– OCR å¼•æ“...', 'info');
            updateProgress(20);
            
            try {
                // åˆ›å»º Tesseract Worker (åªä½¿ç”¨è‹±æ–‡ï¼Œæé«˜é€Ÿåº¦)
                showStatus('æ­£åœ¨åˆå§‹åŒ– OCR å¼•æ“...', 'info');
                updateProgress(30);
                
                const worker = await Tesseract.createWorker('eng');
                showStatus('OCR å¼•æ“åˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡è¯†åˆ«...', 'info');
                updateProgress(40);
                
                // ç®€åŒ–å‚æ•°è®¾ç½®
                try {
                    await worker.setParameters({
                        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+-.,()[]'
                    });
                } catch (paramError) {
                    console.warn('å‚æ•°è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®:', paramError);
                }
                
                showStatus('æ­£åœ¨è¯†åˆ«å›¾ç‰‡æ–‡å­—...', 'info');
                updateProgress(50);
                
                // æ‰§è¡Œ OCR (ä½¿ç”¨é¢„å¤„ç†åçš„å›¾ç‰‡)
                const { data: { text, confidence } } = await worker.recognize(processedImage, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progressPercent = Math.round(40 + (m.progress * 50)); // 40% åˆ° 90%
                            updateProgress(progressPercent);
                            showStatus(`è¯†åˆ«ä¸­... ${progressPercent}%`, 'info');
                        }
                    }
                });
                
                // ç»ˆæ­¢ Worker
                await worker.terminate();
                
                // éšè—è¿›åº¦æ¡ï¼Œæ˜¾ç¤ºç»“æœ
                progressBar.style.display = 'none';
                processBtn.style.display = 'none';
                resetBtn.style.display = 'inline-block';
                
                // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
                showStatus(`è¯†åˆ«å®Œæˆï¼ç½®ä¿¡åº¦: ${Math.round(confidence)}%`, 'success');
                displayResults(text, confidence);
                
            } catch (error) {
                console.error('OCR å¤„ç†é”™è¯¯:', error);
                const errorMessage = error.message || error.toString() || 'æœªçŸ¥é”™è¯¯';
                showStatus('OCR å¤„ç†å¤±è´¥ï¼š' + errorMessage, 'error');
                processBtn.disabled = false;
                processBtn.innerHTML = 'ğŸ” å¼€å§‹ OCR è¯†åˆ«';
                progressBar.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(rawText, confidence) {
            // æ˜¾ç¤ºåŸå§‹æ–‡æœ¬
            document.getElementById('rawText').textContent = rawText;
            
            // è§£æ B30 æ•°æ®
            const parsedData = parseB30Data(rawText);
            
            // å¡«å……æ­Œæ›²è¡¨æ ¼
            fillSongTable(parsedData.songs);
            
            // å¡«å……ç»Ÿè®¡æ•°æ®
            fillStats(parsedData.stats);
            
            // æ˜¾ç¤ºç»“æœå®¹å™¨
            resultContainer.style.display = 'block';
        }
        
        // è§£æ B30 æ•°æ®
        function parseB30Data(text) {
            const songs = [];
            let totalPTT = 0;
            let maxPTT = 0;
            let minPTT = Infinity;
            const difficultyCount = {};
            
            // ç®€åŒ–çš„è§£æé€»è¾‘ - å®é™…åº”ç”¨ä¸­éœ€è¦æ›´å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼å’Œæ¨¡å¼åŒ¹é…
            // è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼Œæ‚¨éœ€è¦æ ¹æ®å®é™…çš„ Arcaea B30 æˆªå›¾æ ¼å¼è¿›è¡Œè°ƒæ•´
            
            // å°è¯•åŒ¹é…æ­Œæ›²è¡Œ
            const lines = text.split('\n');
            
            // è¿™é‡Œæ·»åŠ å®é™…çš„è§£æé€»è¾‘
            // ç¤ºä¾‹æ•°æ®ï¼ˆå®é™…ä½¿ç”¨æ—¶éœ€è¦æ ¹æ® B30 æˆªå›¾æ ¼å¼è°ƒæ•´ï¼‰
            const exampleSongs = [
                { rank: 1, name: "Grievous Lady", difficulty: "FTR", constant: 11.5, score: "9,876,543", ptt: 12.3 },
                { rank: 2, name: "Fracture Ray", difficulty: "BYD", constant: 11.8, score: "9,812,345", ptt: 12.0 },
                { rank: 3, name: "GOODTEK (Arcaea Edit)", difficulty: "FTR", constant: 10.9, score: "9,765,432", ptt: 11.8 },
                // ... æ›´å¤šæ­Œæ›²
            ];
            
            // ä½¿ç”¨ç¤ºä¾‹æ•°æ®
            exampleSongs.forEach(song => {
                songs.push(song);
                totalPTT += song.ptt;
                maxPTT = Math.max(maxPTT, song.ptt);
                minPTT = Math.min(minPTT, song.ptt);
                
                // ç»Ÿè®¡éš¾åº¦åˆ†å¸ƒ
                difficultyCount[song.difficulty] = (difficultyCount[song.difficulty] || 0) + 1;
            });
            
            // å¦‚æœæ²¡æœ‰è§£æåˆ°æ­Œæ›²ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®
            if (songs.length === 0) {
                return {
                    songs: exampleSongs,
                    stats: {
                        totalSongs: exampleSongs.length,
                        averagePTT: (exampleSongs.reduce((sum, song) => sum + song.ptt, 0) / exampleSongs.length).toFixed(2),
                        maxPTT: Math.max(...exampleSongs.map(song => song.ptt)),
                        minPTT: Math.min(...exampleSongs.map(song => song.ptt)),
                        difficultyCount
                    }
                };
            }
            
            const stats = {
                totalSongs: songs.length,
                averagePTT: (totalPTT / songs.length).toFixed(2),
                maxPTT,
                minPTT,
                difficultyCount
            };
            
            return { songs, stats };
        }
        
        // å¡«å……æ­Œæ›²è¡¨æ ¼
        function fillSongTable(songs) {
            const tbody = document.getElementById('songTableBody');
            tbody.innerHTML = '';
            
            songs.forEach(song => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${song.rank}</td>
                    <td>${song.name}</td>
                    <td><span class="difficulty-badge">${song.difficulty}</span></td>
                    <td>${song.constant}</td>
                    <td>${song.score}</td>
                    <td><strong>${song.ptt}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // å¡«å……ç»Ÿè®¡æ•°æ®
        function fillStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            const statsItems = [
                { label: 'æ­Œæ›²æ€»æ•°', value: stats.totalSongs },
                { label: 'å¹³å‡ PTT', value: stats.averagePTT },
                { label: 'æœ€é«˜ PTT', value: stats.maxPTT },
                { label: 'æœ€ä½ PTT', value: stats.minPTT }
            ];
            
            statsItems.forEach(item => {
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-value">${item.value}</div>
                    <div class="stat-label">${item.label}</div>
                `;
                statsGrid.appendChild(statCard);
            });
            
            // éš¾åº¦åˆ†å¸ƒ
            if (Object.keys(stats.difficultyCount).length > 0) {
                const difficultyCard = document.createElement('div');
                difficultyCard.className = 'stat-card';
                difficultyCard.style.gridColumn = '1 / -1';
                
                let difficultyHTML = '<h4>éš¾åº¦åˆ†å¸ƒ</h4><div>';
                for (const [difficulty, count] of Object.entries(stats.difficultyCount)) {
                    difficultyHTML += `${difficulty}: ${count}é¦– `;
                }
                difficultyHTML += '</div>';
                
                difficultyCard.innerHTML = difficultyHTML;
                statsGrid.appendChild(difficultyCard);
            }
        }
        
        // é‡ç½®ä¸Šä¼ 
        function resetUpload() {
            uploadedImage = null;
            fileInput.value = '';
            previewImage.src = '';
            uploadArea.style.display = 'block';
            previewContainer.style.display = 'none';
            processBtn.style.display = 'none';
            resetBtn.style.display = 'none';
            resultContainer.style.display = 'none';
            status.innerHTML = '';
            progressBar.style.display = 'none';
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            progress.style.width = percent + '%';
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            status.innerHTML = `<div class="${className}">${message}</div>`;
        }
    </script>
</body>
</html>