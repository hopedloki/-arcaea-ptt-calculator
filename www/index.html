<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcaea PTT è®¡ç®—å™¨</title>
    
    <!-- PWA æ”¯æŒ -->
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arcaea PTT">
    <meta name="application-name" content="Arcaea PTT Calculator">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfNSkiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI2IiB5PSI2Ij4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iMiIgZmlsbD0iIzY2N2VlYSIvPgo8dGV4dCB4PSIxMCIgeT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEwIiBmb250LXdlaWdodD0iYm9sZCI+UFQ8L3RleHQ+Cjwvc3ZnPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfNSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPg==">
    
    <!-- å›¾æ ‡æ”¯æŒ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfNSkiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI2IiB5PSI2Ij4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iMiIgZmlsbD0iIzY2N2VlYSIvPgo8dGV4dCB4PSIxMCIgeT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEwIiBmb250LXdlaWdodD0iYm9sZCI+UFQ8L3RleHQ+Cjwvc3ZnPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfNSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPg==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .result-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .result-formula {
            font-size: 12px;
            color: #888;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
        }

        .grade-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .grade-pm { background: #ffd700; color: #333; }
        .grade-ex { background: #87ceeb; color: #333; }
        .grade-uc { background: #98fb98; color: #333; }
        .grade-c { background: #dda0dd; color: #333; }
        .grade-b { background: #f0e68c; color: #333; }
        .grade-a { background: #ffb6c1; color: #333; }
        .grade-d { background: #d3d3d3; color: #333; }
        
        .tolerance-details {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .tolerance-mode-toggle {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            padding: 3px;
        }

        .tolerance-mode-btn {
            flex: 1;
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            margin: 0 1px;
        }

        .tolerance-mode-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.2);
        }

        .tolerance-input-section {
            display: none;
        }

        .tolerance-input-section.active {
            display: block;
        }

        .info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .info-content {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .formula-table {
            width: 100%;
            font-size: 11px;
            margin-top: 10px;
            border-collapse: collapse;
        }

        .formula-table th,
        .formula-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .formula-table th {
            background: rgba(102, 126, 234, 0.1);
            color: #333;
            font-weight: 600;
        }



        .mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 25px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .input-section {
            display: none;
        }

        .input-section.active {
            display: block;
        }

        @media (max-width: 480px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .result-value {
                font-size: 28px;
            }
        }

        /* B30æ¨¡å¼æ ·å¼ */
        .search-results {
            position: absolute;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .search-result-item:hover {
            background-color: #f5f7fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
        .custom-select {
            position: relative;
        }
        
        .difficulty-results {
            position: absolute;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        
        .difficulty-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .difficulty-item:hover {
            background-color: #f5f7fa;
        }

        .difficulty-item:last-child {
            border-bottom: none;
        }

        .b30-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .b30-controls-row {
            grid-column: span 2;
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .add-btn, .clear-btn, .export-btn, .import-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .add-btn, .export-btn {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .add-btn:hover, .export-btn:hover {
            background: #5a67d8;
            box-shadow: 0 6px 10px rgba(102, 126, 234, 0.4);
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }

        .clear-btn:hover {
            background: #c0392b;
            box-shadow: 0 6px 10px rgba(231, 76, 60, 0.4);
        }

        .import-btn {
            background: #9b59b6;
            color: white;
            box-shadow: 0 2px 5px rgba(155, 89, 182, 0.3);
        }

        .import-btn:hover {
            background: #8e44ad;
            box-shadow: 0 6px 10px rgba(155, 89, 182, 0.4);
        }



        .b30-list-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .b30-list-container h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .b30-songs {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .b30-song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .b30-song-item:last-child {
            border-bottom: none;
        }

        .b30-song-info {
            flex: 1;
        }

        .b30-song-name {
            font-weight: 600;
            color: #333;
        }

        .b30-song-details {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .b30-song-score {
            text-align: right;
            margin-right: 15px;
        }

        .b30-song-score-value {
            font-weight: 600;
            color: #667eea;
        }

        .b30-song-ptt {
            font-size: 12px;
            color: #888;
        }

        .b30-song-actions {
            display: flex;
            gap: 5px;
        }

        .b30-edit-btn, .b30-delete-btn {
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .b30-edit-btn {
            background: #3498db;
        }

        .b30-edit-btn:hover {
            background: #2980b9;
        }

        .b30-delete-btn {
            background: #e74c3c;
        }

        .b30-delete-btn:hover {
            background: #c0392b;
        }

        .b30-summary {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
        }

        .b30-summary h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .b30-stats {
            display: flex;
            justify-content: space-around;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .input-group {
            position: relative;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 600px) {
            .b30-controls {
                grid-template-columns: 1fr;
            }
            
            .b30-buttons {
                grid-column: span 1;
            }
            
            .b30-stats {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ Arcaea PTT è®¡ç®—å™¨</h1>
        <p class="subtitle">åŒå‘è®¡ç®—å·¥å…· - æ”¯æŒPTTä¸æˆç»©äº’è½¬</p>
        
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="switchMode('ptt')">æˆç»©â†’PTT</button>
            <button class="mode-btn" onclick="switchMode('score')">PTTâ†’æˆç»©</button>
            <button class="mode-btn" onclick="switchMode('tolerance')">å®¹é”™è®¡ç®—</button>
            <button class="mode-btn" onclick="switchMode('b30')">B30å½•å…¥</button>
        </div>
        
        <!-- æˆç»©è½¬PTTæ¨¡å¼ -->
        <div id="ptt-mode" class="input-section active">
            <div class="input-group">
                <label for="chart-constant-ptt">è°±é¢å®šæ•° (Chart Constant)</label>
                <input type="number" id="chart-constant-ptt" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
            </div>
            
            <div class="input-group">
                <label for="score-ptt">å•æ›²æˆç»© (Score)</label>
                <input type="number" id="score-ptt" step="10000" min="0" max="10000000" placeholder="ä¾‹å¦‚: 9690000" />
            </div>
        </div>
        
        <!-- PTTè½¬æˆç»©æ¨¡å¼ -->
        <div id="score-mode" class="input-section">
            <div class="input-group">
                <label for="chart-constant-score">è°±é¢å®šæ•° (Chart Constant)</label>
                <input type="number" id="chart-constant-score" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
            </div>
            
            <div class="input-group">
                <label for="ptt-score">å•æ›²PTT (Single PTT)</label>
                <input type="number" id="ptt-score" step="0.01" min="0" max="15" placeholder="ä¾‹å¦‚: 11.73" />
            </div>
        </div>
        
        <!-- å®¹é”™è®¡ç®—æ¨¡å¼ -->
        <div id="tolerance-mode" class="input-section">
            <div class="tolerance-mode-toggle">
                <button class="tolerance-mode-btn active" onclick="switchToleranceMode('grade')">è¯„çº§å®¹é”™</button>
                <button class="tolerance-mode-btn" onclick="switchToleranceMode('score')">æˆç»©å®¹é”™</button>
                <button class="tolerance-mode-btn" onclick="switchToleranceMode('ptt')">PTTå®¹é”™</button>
            </div>
            
            <!-- è¯„çº§å®¹é”™æ¨¡å¼ -->
            <div id="grade-tolerance" class="tolerance-input-section active">
                <div class="input-group">
                    <label for="note-count-grade">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-grade" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="target-grade">ç›®æ ‡è¯„çº§ (Target Grade)</label>
                    <select id="target-grade" style="width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; background: white; transition: all 0.3s ease;">
                        <option value="PM">PM (Pure Memory) - 10,000,000åˆ†</option>
                        <option value="EX+">EX+ - 9,900,000åˆ†</option>
                        <option value="EX" selected>EX - 9,800,000åˆ†</option>
                        <option value="UC">UC - 9,700,000åˆ†</option>
                        <option value="C">C - 9,500,000åˆ†</option>
                        <option value="B">B - 9,200,000åˆ†</option>
                        <option value="A">A - 8,900,000åˆ†</option>
                        <option value="D">D - 8,900,000åˆ†ä»¥ä¸‹</option>
                    </select>
                </div>
            </div>
            
            <!-- æˆç»©å®¹é”™æ¨¡å¼ -->
            <div id="score-tolerance" class="tolerance-input-section">
                <div class="input-group">
                    <label for="note-count-score">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-score" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="target-score">ç›®æ ‡æˆç»© (Target Score)</label>
                    <input type="number" id="target-score" step="10000" min="0" max="10000000" placeholder="ä¾‹å¦‚: 9850000" />
                </div>
            </div>
            
            <!-- PTTå®¹é”™æ¨¡å¼ -->
            <div id="ptt-tolerance" class="tolerance-input-section">
                <div class="input-group">
                    <label for="note-count-ptt">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-ptt" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="chart-constant-ptt-tolerance">è°±é¢å®šæ•° (Chart Constant)</label>
                    <input type="number" id="chart-constant-ptt-tolerance" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
                </div>
                
                <div class="input-group">
                    <label for="target-ptt">ç›®æ ‡å•æ›²PTT (Target Single PTT)</label>
                    <input type="number" id="target-ptt" step="0.01" min="0" max="15" placeholder="ä¾‹å¦‚: 11.5" />
                </div>
            </div>
        </div>
        
        <!-- B30å½•å…¥æ¨¡å¼ -->
        <div id="b30-mode" class="input-section">
            <div class="input-group">
                <label for="song-search">æœç´¢æ­Œæ›² (æ­Œåæˆ–å®šæ•°)</label>
                <input type="text" id="song-search" placeholder="è¾“å…¥æ­Œæ›²åç§°æˆ–å®šæ•°æœç´¢" oninput="searchSongs()" />
                <div id="search-results" class="search-results"></div>
            </div>
            
            <div class="b30-controls">
                <div class="input-group">
                    <label for="selected-song-name">å·²é€‰æ‹©æ­Œæ›²</label>
                    <input type="text" id="selected-song-name" readonly placeholder="æœç´¢åè‡ªåŠ¨å¡«å……" />
                    <input type="hidden" id="selected-song" value="" />
                </div>
                
                <div class="input-group">
                    <label for="difficulty-select">é€‰æ‹©éš¾åº¦</label>
                    <div class="custom-select">
                        <input type="text" id="difficulty-input" readonly placeholder="è¯·å…ˆé€‰æ‹©æ­Œæ›²" onclick="toggleDifficultyDropdown()" />
                        <div id="difficulty-results" class="difficulty-results"></div>
                        <input type="hidden" id="difficulty-select" value="" />
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="song-constant">å®šæ•°</label>
                    <input type="number" id="song-constant" step="0.1" min="0" max="13" readonly placeholder="é€‰æ‹©æ­Œæ›²åè‡ªåŠ¨å¡«å……" />
                </div>
                
                <div class="input-group">
                    <label for="song-score">æˆç»© (0-10,000,000)</label>
                    <input type="number" id="song-score" step="10000" min="0" max="10000000" placeholder="è¾“å…¥æˆç»©" />
                </div>
                
                <div class="b30-controls-row">
                    <button class="add-btn" id="add-to-b30-btn">æ·»åŠ åˆ°B30</button>
                    <button class="clear-btn" id="clear-b30-btn">æ¸…ç©ºB30</button>
                </div>
                
                <div class="b30-controls-row">
                    <button class="export-btn" onclick="exportB30Data()">å¯¼å‡ºæ•°æ®</button>
                    <button class="import-btn" onclick="document.getElementById('import-file').click()">å¯¼å…¥æ•°æ®</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importB30Data(event)" />
                </div>
            </div>
            
            <div class="b30-list-container">
                <h3>B30æˆç»©åˆ—è¡¨ (<span id="b30-count">0</span>/30)</h3>
                <div id="b30-songs" class="b30-songs">æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ æˆç»©</div>
                
                <div class="b30-summary" id="b30-summary" style="display: none;">
                    <h4>B30ç»Ÿè®¡</h4>
                    <div class="b30-stats">
                        <div class="stat-item">
                            <div class="stat-label">B30 PTT</div>
                            <div class="stat-value" id="b30-ptt">0.00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">B10 PTTå¹³å‡å€¼</div>
                            <div class="stat-value" id="b10-ptt">0.00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åœ°æ¿PTT</div>
                            <div class="stat-value" id="floor-ptt">0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="result-container" id="result-container">
            <div class="result-label" id="result-label">è®¡ç®—ç»“æœ</div>
            <div class="result-value" id="result-value">-</div>
            <div id="grade-badge"></div>
            <div class="result-formula" id="result-formula">è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—</div>
        </div>
        
        <div class="info-section">
            <div class="info-title">ğŸ“Š PTT è®¡ç®—å…¬å¼</div>
            <div class="info-content">
                <table class="formula-table">
                    <thead>
                        <tr>
                            <th>å¾—åˆ†åŒºé—´</th>
                            <th>è®¡ç®—å…¬å¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>â‰¥ 10,000,000 (PM)</td>
                            <td>å®šæ•° + 2.0</td>
                        </tr>
                        <tr>
                            <td>9,900,000 ~ 9,999,999</td>
                            <td>å®šæ•° + 1.5 + (å¾—åˆ†-9,900,000)/100,000</td>
                        </tr>
                        <tr>
                            <td>9,800,000 ~ 9,899,999</td>
                            <td>å®šæ•° + 1.0 + (å¾—åˆ†-9,800,000)/400,000</td>
                        </tr>
                        <tr>
                            <td>â‰¤ 9,800,000</td>
                            <td>å®šæ•° + (å¾—åˆ†-9,500,000)/300,000</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'ptt';
        let toleranceMode = 'grade';

        function switchMode(mode) {
            currentMode = mode;
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ¢è¾“å…¥åŒºåŸŸ
            document.querySelectorAll('.input-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${mode}-mode`).classList.add('active');
            
            // æ¸…ç©ºç»“æœ
            document.getElementById('result-value').textContent = '-';
            document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—';
            document.getElementById('grade-badge').innerHTML = '';
            
            // æ›´æ–°ç»“æœæ ‡ç­¾
            if (mode === 'ptt') {
                document.getElementById('result-label').textContent = 'å•æ›²PTT';
            } else if (mode === 'score') {
                document.getElementById('result-label').textContent = 'æ‰€éœ€æˆç»©';
            } else if (mode === 'tolerance') {
                document.getElementById('result-label').textContent = 'Farå®¹é”™';
            } else if (mode === 'b30') {
                document.getElementById('result-label').textContent = 'B30ç®¡ç†';
            }
        }

        function calculatePTT(chartConstant, score) {
            let ptt;
            let formula;
            
            if (score >= 10000000) {
                ptt = chartConstant + 2.0;
                formula = `${chartConstant} + 2.0`;
            } else if (score >= 9900000) {
                const bonus = (score - 9900000) / 100000;
                ptt = chartConstant + 1.5 + bonus;
                formula = `${chartConstant} + 1.5 + (${score.toLocaleString()} - 9,900,000)/100,000`;
            } else if (score >= 9800000) {
                const bonus = (score - 9800000) / 400000;
                ptt = chartConstant + 1.0 + bonus;
                formula = `${chartConstant} + 1.0 + (${score.toLocaleString()} - 9,800,000)/400,000`;
            } else {
                const bonus = Math.max(0, (score - 9500000) / 300000);
                ptt = chartConstant + bonus;
                formula = `${chartConstant} + (${score.toLocaleString()} - 9,500,000)/300,000`;
            }
            
            return {
                ptt: Math.max(0, ptt),
                formula: formula,
                grade: getGrade(score)
            };
        }

        function calculateScore(chartConstant, targetPTT) {
            let score;
            let formula;
            let possible = true;
            
            // æ£€æŸ¥ç›®æ ‡PTTæ˜¯å¦å¯èƒ½è¾¾åˆ°
            const maxPTT = chartConstant + 2.0; // PMæ—¶çš„æœ€é«˜PTT
            if (targetPTT > maxPTT) {
                possible = false;
                return {
                    score: 0,
                    formula: `ç›®æ ‡PTT ${targetPTT.toFixed(2)} è¶…è¿‡ç†è®ºæœ€å¤§å€¼ ${maxPTT.toFixed(2)}`,
                    possible: false
                };
            }
            
            const targetBonus = targetPTT - chartConstant;
            
            if (targetBonus >= 2.0) {
                score = 10000000;
                formula = `ç›®æ ‡PTT â‰¥ å®šæ•°+2.0ï¼Œéœ€è¦è¾¾åˆ° PM (10,000,000åˆ†)`;
            } else if (targetBonus >= 1.5) {
                score = 9900000 + (targetBonus - 1.5) * 100000;
                formula = `9900000 + (${targetPTT.toFixed(2)} - ${chartConstant} - 1.5) Ã— 100,000`;
            } else if (targetBonus >= 1.0) {
                score = 9800000 + (targetBonus - 1.0) * 400000;
                formula = `9800000 + (${targetPTT.toFixed(2)} - ${chartConstant} - 1.0) Ã— 400,000`;
            } else if (targetBonus > 0) {
                score = 9500000 + targetBonus * 300000;
                formula = `9500000 + (${targetPTT.toFixed(2)} - ${chartConstant}) Ã— 300,000`;
            } else {
                score = 9500000 + targetBonus * 300000; // å¯èƒ½ä¸ºè´Ÿæ•°
                formula = `9500000 + (${targetPTT.toFixed(2)} - ${chartConstant}) Ã— 300,000`;
            }
            
            // é™åˆ¶åˆ†æ•°èŒƒå›´
            score = Math.max(0, Math.min(10000000, Math.round(score)));
            
            return {
                score: score,
                formula: formula,
                possible: true,
                grade: getGrade(score)
            };
        }
        
        function getGrade(score) {
            if (score >= 10000000) return { name: 'PM', class: 'grade-pm' };
            if (score >= 9900000) return { name: 'EX+', class: 'grade-ex' };
            if (score >= 9800000) return { name: 'EX', class: 'grade-ex' };
            if (score >= 9700000) return { name: 'UC', class: 'grade-uc' };
            if (score >= 9500000) return { name: 'C', class: 'grade-c' };
            if (score >= 9200000) return { name: 'B', class: 'grade-b' };
            if (score >= 8900000) return { name: 'A', class: 'grade-a' };
            return { name: 'D', class: 'grade-d' };
        }
        
        function updateResult() {
            if (currentMode === 'ptt') {
                updatePTTResult();
            } else if (currentMode === 'score') {
                updateScoreResult();
            } else {
                updateToleranceResult();
            }
        }

        function updatePTTResult() {
            const chartConstant = parseFloat(document.getElementById('chart-constant-ptt').value);
            const score = parseInt(document.getElementById('score-ptt').value);
            
            if (isNaN(chartConstant) || isNaN(score)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„å®šæ•°å’Œæˆç»©';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (score < 0 || score > 10000000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'æˆç»©åº”åœ¨ 0-10,000,000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            const result = calculatePTT(chartConstant, score);
            
            document.getElementById('result-value').textContent = result.ptt.toFixed(2);
            document.getElementById('result-formula').textContent = `${result.formula} = ${result.ptt.toFixed(2)}`;
            
            const grade = result.grade;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;
        }

        function updateScoreResult() {
            const chartConstant = parseFloat(document.getElementById('chart-constant-score').value);
            const targetPTT = parseFloat(document.getElementById('ptt-score').value);
            
            if (isNaN(chartConstant) || isNaN(targetPTT)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„å®šæ•°å’ŒPTT';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (targetPTT < 0 || targetPTT > 15) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'PTTåº”åœ¨ 0-15 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            const result = calculateScore(chartConstant, targetPTT);
            
            if (!result.possible) {
                document.getElementById('result-value').textContent = 'ä¸å¯èƒ½';
                document.getElementById('result-formula').textContent = result.formula;
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            document.getElementById('result-value').textContent = result.score.toLocaleString();
            document.getElementById('result-formula').textContent = `${result.formula} = ${result.score.toLocaleString()}`;
            
            const grade = result.grade;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;
        }

        function calculateTolerance(noteCount, targetGrade) {
            const gradeScores = {
                'PM': 10000000,
                'EX+': 9900000,
                'EX': 9800000,
                'UC': 9700000,
                'C': 9500000,
                'B': 9200000,
                'A': 8900000,
                'D': 8899999 // ä½¿ç”¨8899999æ¥è¡¨ç¤ºDè¯„çº§
            };

            const targetScore = gradeScores[targetGrade];
            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;

            let maxFarCount;
            let resultText;

            if (targetGrade === 'PM') {
                // PMéœ€è¦0ä¸ªFarï¼Œå…¨æ˜¯Pure
                maxFarCount = 0;
                resultText = `PMéœ€è¦å…¨Pureåˆ¤å®šï¼Œä¸å…è®¸ä»»ä½•Far`;
            } else if (targetGrade === 'D') {
                // Dè¯„çº§å®¹é”™å¤ªå¤šï¼Œè®¡ç®—åˆ°æ‰€æœ‰Far
                maxFarCount = Math.floor(noteCount * 0.9); // 90%ä¸ºFar
                resultText = `Dè¯„çº§å®¹é”™æå¤§ï¼Œè¿™é‡Œè®¡ç®—90%å®¹é”™`;
            } else {
                // å…¶ä»–è¯„çº§è®¡ç®—æœ€å¤§Faræ•°é‡
                const maxLostScore = 10000000 - targetScore;
                maxFarCount = Math.floor(maxLostScore / farLoss);
                
                // ç¡®ä¿ä¸è¶…è¿‡æ€»Noteæ•°
                maxFarCount = Math.min(maxFarCount, noteCount);
                
                const pureCount = noteCount - maxFarCount;
                const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
                
                resultText = `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†`;
            }

            const pureCount = noteCount - maxFarCount;
            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            return {
                maxFarCount: maxFarCount,
                pureCount: pureCount,
                farPercentage: farPercentage,
                purePercentage: purePercentage,
                targetScore: targetScore,
                resultText: resultText,
                singleNoteScore: singleNoteScore,
                farLoss: farLoss
            };
        }

        function switchToleranceMode(mode) {
            toleranceMode = mode;
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tolerance-mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ¢è¾“å…¥åŒºåŸŸ
            document.querySelectorAll('.tolerance-input-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${mode}-tolerance`).classList.add('active');
            
            // æ¸…ç©ºç»“æœ
            document.getElementById('result-value').textContent = '-';
            document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—';
            document.getElementById('grade-badge').innerHTML = '';
        }

        function updateToleranceResult() {
            if (toleranceMode === 'grade') {
                updateGradeToleranceResult();
            } else if (toleranceMode === 'score') {
                updateScoreToleranceResult();
            } else {
                updatePTTToleranceResult();
            }
        }

        function updateGradeToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-grade').value);
            const targetGrade = document.getElementById('target-grade').value;

            if (isNaN(noteCount) || noteCount <= 0) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const result = calculateTolerance(noteCount, targetGrade);
            
            document.getElementById('result-value').textContent = result.maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge grade-${targetGrade.toLowerCase().replace('+', '')}">${targetGrade}</span>`;

            let detailedInfo = `${result.resultText}\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${result.singleNoteScore.toFixed(2)}åˆ†\n`;
            detailedInfo += `å•ä¸ªFaræŸå¤±: ${result.farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${result.farPercentage}% | Pureéœ€æ±‚ç‡: ${result.purePercentage}%`;

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function updateScoreToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-score').value);
            const targetScore = parseInt(document.getElementById('target-score').value);

            if (isNaN(noteCount) || noteCount <= 0 || isNaN(targetScore)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡å’Œç›®æ ‡æˆç»©';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (targetScore < 0 || targetScore > 10000000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'æˆç»©åº”åœ¨ 0-10,000,000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;
            const maxLostScore = 10000000 - targetScore;
            
            // è®¡ç®—æœ€å¤§Faræ•°é‡
            let maxFarCount = Math.floor(maxLostScore / farLoss);
            maxFarCount = Math.min(maxFarCount, noteCount);
            maxFarCount = Math.max(0, maxFarCount);
            
            const pureCount = noteCount - maxFarCount;
            const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
            const grade = getGrade(targetScore);
            
            // è®¡ç®—è¿˜æœ‰å¤šå°‘åˆ†åˆ°ä¸‹ä¸€ä¸ªè¯„çº§
            const nextGradeScore = getNextGradeScore(targetScore);
            const scoreToNextGrade = nextGradeScore > targetScore ? nextGradeScore - targetScore : 0;
            const farToNextGrade = scoreToNextGrade > 0 ? Math.ceil(scoreToNextGrade / farLoss) : 0;

            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            document.getElementById('result-value').textContent = maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;

            let detailedInfo = `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `ç›®æ ‡æˆç»©: ${targetScore.toLocaleString()}åˆ† | å®é™…å¯è¾¾: ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${singleNoteScore.toFixed(2)}åˆ† | å•ä¸ªFaræŸå¤±: ${farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${farPercentage}% | Pureéœ€æ±‚ç‡: ${purePercentage}%`;
            
            if (scoreToNextGrade > 0 && farToNextGrade > 0) {
                detailedInfo += `\nè·ç¦»ä¸Šä¸€è¯„çº§è¿˜éœ€å‡å°‘ ${farToNextGrade} ä¸ªFar`;
            }

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function updatePTTToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-ptt').value);
            const chartConstant = parseFloat(document.getElementById('chart-constant-ptt-tolerance').value);
            const targetPTT = parseFloat(document.getElementById('target-ptt').value);

            if (isNaN(noteCount) || noteCount <= 0 || isNaN(chartConstant) || isNaN(targetPTT)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡ã€å®šæ•°å’Œç›®æ ‡PTT';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (targetPTT < 0 || targetPTT > 15) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'PTTåº”åœ¨ 0-15 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            // å°†PTTè½¬æ¢ä¸ºå¯¹åº”çš„æˆç»©
            const scoreResult = calculateScore(chartConstant, targetPTT);
            
            if (!scoreResult.possible) {
                document.getElementById('result-value').textContent = 'ä¸å¯èƒ½';
                document.getElementById('result-formula').textContent = scoreResult.formula;
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const targetScore = scoreResult.score;
            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;
            const maxLostScore = 10000000 - targetScore;
            
            // è®¡ç®—æœ€å¤§Faræ•°é‡
            let maxFarCount = Math.floor(maxLostScore / farLoss);
            maxFarCount = Math.min(maxFarCount, noteCount);
            maxFarCount = Math.max(0, maxFarCount);
            
            const pureCount = noteCount - maxFarCount;
            const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
            const grade = getGrade(targetScore);
            
            // è®¡ç®—PTTæå‡ç©ºé—´
            const maxPTT = chartConstant + 2.0;
            const pttToNextLevel = getPTTToNextLevel(targetPTT);

            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            document.getElementById('result-value').textContent = maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;

            let detailedInfo = `ç›®æ ‡PTT ${targetPTT.toFixed(2)} éœ€è¦ ${targetScore.toLocaleString()}åˆ†\n`;
            detailedInfo += `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${singleNoteScore.toFixed(2)}åˆ† | å•ä¸ªFaræŸå¤±: ${farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${farPercentage}% | Pureéœ€æ±‚ç‡: ${purePercentage}%\n`;
            detailedInfo += `è°±é¢æœ€é«˜PTT: ${maxPTT.toFixed(2)} | å½“å‰PTTç›®æ ‡: ${targetPTT.toFixed(2)}`;
            
            if (pttToNextLevel.nextPTT > targetPTT) {
                const farNeededToNext = Math.ceil((pttToNextLevel.scoreNeeded - targetScore) / farLoss);
                detailedInfo += `\nè¾¾åˆ°${pttToNextLevel.nextPTT.toFixed(2)}PTTè¿˜éœ€å‡å°‘${farNeededToNext}ä¸ªFar`;
            }

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function getPTTToNextLevel(currentPTT) {
            // è®¡ç®—ä¸‹ä¸€ä¸ªé‡è¦çš„PTTé‡Œç¨‹ç¢‘ï¼ˆé€šå¸¸æ˜¯æ•´æ•°æˆ–0.5çš„å€æ•°ï¼‰
            const nextMilestone = Math.ceil(currentPTT * 2) / 2; // å‘ä¸Šå–æ•´åˆ°0.5
            if (nextMilestone <= currentPTT) {
                return { nextPTT: currentPTT + 0.5, scoreNeeded: 0 };
            }
            
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„è®¡ç®—
            return { 
                nextPTT: nextMilestone, 
                scoreNeeded: 0 // å®é™…åº”è¯¥è®¡ç®—å¯¹åº”åˆ†æ•°
            };
        }

        function getNextGradeScore(currentScore) {
            if (currentScore >= 10000000) return 10000000;
            if (currentScore >= 9900000) return 10000000;  // EX+ to PM
            if (currentScore >= 9800000) return 9900000;  // EX to EX+
            if (currentScore >= 9700000) return 9800000;  // UC to EX
            if (currentScore >= 9500000) return 9700000;  // C to UC
            if (currentScore >= 9200000) return 9500000;  // B to C
            if (currentScore >= 8900000) return 9200000;  // A to B
            return 8900000;  // Below A to A
        }
        
        // å®æ—¶è®¡ç®—
        document.getElementById('chart-constant-ptt').addEventListener('input', updateResult);
        document.getElementById('score-ptt').addEventListener('input', updateResult);
        document.getElementById('chart-constant-score').addEventListener('input', updateResult);
        document.getElementById('ptt-score').addEventListener('input', updateResult);
        document.getElementById('note-count-grade').addEventListener('input', updateResult);
        document.getElementById('note-count-score').addEventListener('input', updateResult);
        document.getElementById('note-count-ptt').addEventListener('input', updateResult);
        document.getElementById('target-score').addEventListener('input', updateResult);
        document.getElementById('target-ptt').addEventListener('input', updateResult);
        document.getElementById('chart-constant-ptt-tolerance').addEventListener('input', updateResult);
        document.getElementById('target-grade').addEventListener('change', updateResult);
        
        // æ·»åŠ ç¤ºä¾‹è®¡ç®—
        document.getElementById('chart-constant-ptt').value = '11.1';
        document.getElementById('score-ptt').value = '9690000';
        
        // å®¹é”™æ¨¡å¼ç¤ºä¾‹
        document.getElementById('note-count-grade').value = '1200';
        document.getElementById('note-count-score').value = '1200';
        document.getElementById('note-count-ptt').value = '1200';
        document.getElementById('target-score').value = '9850000';
        document.getElementById('chart-constant-ptt-tolerance').value = '11.1';
        document.getElementById('target-ptt').value = '11.5';
        document.getElementById('target-grade').value = 'EX';
        
        updateResult();
        
        // B30å½•å…¥åŠŸèƒ½
        let songConstants = {}; // ç”¨äºå­˜å‚¨æ­Œæ›²å®šæ•°æ•°æ®
        let b30Data = []; // ç”¨äºå­˜å‚¨B30æˆç»©æ•°æ®
        
        // åŠ è½½æ­Œæ›²å®šæ•°æ•°æ®
        async function loadSongConstants() {
            try {
                const response = await fetch('./song-constants.json');
                songConstants = await response.json();
                console.log('æ­Œæ›²å®šæ•°æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(songConstants).length, 'é¦–æ­Œæ›²');
            } catch (error) {
                console.error('åŠ è½½æ­Œæ›²å®šæ•°æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // æœç´¢æ­Œæ›²
        function searchSongs() {
            const searchTerm = document.getElementById('song-search').value.toLowerCase().trim();
            const searchResults = document.getElementById('search-results');
            
            console.log('æœç´¢è¯:', searchTerm);
            console.log('æ­Œæ›²æ•°æ®æ€»æ•°:', Object.keys(songConstants).length);
            
            if (searchTerm.length < 1) {
                searchResults.innerHTML = '';
                return;
            }
            
            let results = [];
            
            // æœç´¢æ­Œå
            for (const songName in songConstants) {
                if (songName.toLowerCase().includes(searchTerm)) {
                    results.push({ name: songName, type: 'name' });
                }
            }
            
            // æœç´¢å®šæ•°
            const searchConstant = parseFloat(searchTerm);
            if (!isNaN(searchConstant)) {
                for (const songName in songConstants) {
                    const difficulties = songConstants[songName];
                    for (const diff in difficulties) {
                        if (difficulties[diff] !== null && Math.abs(difficulties[diff] - searchConstant) < 0.01) {
                            if (!results.find(r => r.name === songName)) {
                                results.push({ name: songName, type: 'constant', constant: searchConstant });
                            }
                            break;
                        }
                    }
                }
            }
            
            // é™åˆ¶ç»“æœæ•°é‡
            if (results.length > 10) {
                results = results.slice(0, 10);
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            displaySearchResults(results);
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²</div>';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                const displayText = result.type === 'constant' 
                    ? `${result.name} (å®šæ•°: ${result.constant})` 
                    : result.name;
                html += `<div class="search-result-item" onclick="selectSong('${result.name}')">${displayText}</div>`;
            });
            
            searchResults.innerHTML = html;
        }
        
        // é€‰æ‹©æ­Œæ›²
        function selectSong(songName) {
            document.getElementById('song-search').value = songName;
            document.getElementById('selected-song-name').value = songName;
            document.getElementById('selected-song').value = songName;
            document.getElementById('search-results').innerHTML = '';
            updateDifficultySelect();
        }
        
        // æ›´æ–°éš¾åº¦é€‰æ‹©
        function updateDifficultySelect() {
            const selectedSongInput = document.getElementById('selected-song');
            const difficultyInput = document.getElementById('difficulty-input');
            const difficultySelect = document.getElementById('difficulty-select');
            const difficultyResults = document.getElementById('difficulty-results');
            const constantInput = document.getElementById('song-constant');
            
            // æ¸…ç©ºéš¾åº¦é€‰æ‹©
            difficultyInput.value = 'è¯·é€‰æ‹©éš¾åº¦';
            difficultySelect.value = '';
            difficultyResults.innerHTML = '';
            constantInput.value = '';
            
            // è·å–é€‰ä¸­çš„æ­Œæ›²
            const selectedSong = selectedSongInput.value;
            console.log('æ›´æ–°éš¾åº¦é€‰æ‹©ï¼Œå½“å‰æ­Œæ›²:', selectedSong);
            
            if (!selectedSong || !songConstants[selectedSong]) {
                difficultyInput.value = 'è¯·å…ˆé€‰æ‹©æ­Œæ›²';
                console.log('æœªæ‰¾åˆ°æ­Œæ›²æ•°æ®æˆ–æœªé€‰æ‹©æ­Œæ›²');
                return;
            }
            
            const difficulties = songConstants[selectedSong];
            const difficultyOrder = ['byd', 'ftr', 'prs', 'pst', 'etr'];
            
            // æŒ‰éš¾åº¦é¡ºåºæ·»åŠ é€‰é¡¹
            let html = '';
            difficultyOrder.forEach(diff => {
                const constant = difficulties[diff];
                if (constant !== null && constant !== undefined) {
                    html += `<div class="difficulty-item" onclick="selectDifficulty('${diff}', '${diff.toUpperCase()} (${constant.toFixed(1)})')">${diff.toUpperCase()} (${constant.toFixed(1)})</div>`;
                }
            });
            
            difficultyResults.innerHTML = html;
            
            // å¦‚æœæœ‰å·²é€‰æ‹©çš„éš¾åº¦ï¼Œæ˜¾ç¤ºå®ƒ
            if (difficultySelect.value) {
                const selectedDifficulty = difficultySelect.value;
                const constant = difficulties[selectedDifficulty];
                if (constant !== null && constant !== undefined) {
                    difficultyInput.value = `${selectedDifficulty.toUpperCase()} (${constant.toFixed(1)})`;
                }
            } else {
                difficultyInput.value = 'ç‚¹å‡»é€‰æ‹©éš¾åº¦';
            }
        }
        
        // åˆ‡æ¢éš¾åº¦ä¸‹æ‹‰åˆ—è¡¨
        function toggleDifficultyDropdown() {
            const difficultyResults = document.getElementById('difficulty-results');
            const isHidden = difficultyResults.style.display === 'none';
            
            // å…³é—­æ‰€æœ‰ä¸‹æ‹‰åˆ—è¡¨
            document.getElementById('difficulty-results').style.display = 'none';
            document.getElementById('search-results').innerHTML = '';
            
            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰åˆ—è¡¨
            if (isHidden && document.getElementById('difficulty-input').value !== 'è¯·å…ˆé€‰æ‹©æ­Œæ›²') {
                difficultyResults.style.display = 'block';
            }
        }
        
        // é€‰æ‹©éš¾åº¦
        function selectDifficulty(difficulty, displayText) {
            document.getElementById('difficulty-input').value = displayText;
            document.getElementById('difficulty-select').value = difficulty;
            document.getElementById('difficulty-results').style.display = 'none';
            updateConstant();
        }
        
        // æ›´æ–°å®šæ•°
        function updateConstant() {
            const selectedSongInput = document.getElementById('selected-song');
            const difficultySelect = document.getElementById('difficulty-select');
            const constantInput = document.getElementById('song-constant');
            
            const selectedSong = selectedSongInput.value;
            const selectedDifficulty = difficultySelect.value;
            
            if (!selectedSong || !selectedDifficulty || !songConstants[selectedSong]) {
                constantInput.value = '';
                return;
            }
            
            const constant = songConstants[selectedSong][selectedDifficulty];
            if (constant !== null && constant !== undefined) {
                constantInput.value = constant.toFixed(1);
            } else {
                constantInput.value = '';
            }
        }
        
        // æ·»åŠ æ­Œæ›²åˆ°B30
        function addSongToB30() {
            console.log('addSongToB30 å‡½æ•°è¢«è°ƒç”¨');
            
            const selectedSongInput = document.getElementById('selected-song');
            const difficultySelect = document.getElementById('difficulty-select');
            const constantInput = document.getElementById('song-constant');
            const scoreInput = document.getElementById('song-score');
            
            const song = selectedSongInput.value;
            const difficulty = difficultySelect.value;
            const constant = parseFloat(constantInput.value);
            const score = parseInt(scoreInput.value);
            
            console.log('è¾“å…¥å€¼:', { song, difficulty, constant, score });
            
            if (!song || !difficulty || isNaN(constant) || isNaN(score)) {
                alert('è¯·å®Œæ•´å¡«å†™æ›²ç›®ã€éš¾åº¦ã€å®šæ•°å’Œæˆç»©');
                return;
            }
            
            if (score < 0 || score > 10000000) {
                alert('æˆç»©åº”åœ¨ 0-10,000,000 èŒƒå›´å†…');
                return;
            }
            
            // æ£€æŸ¥æˆç»©æ˜¯å¦è¶…è¿‡æœ€é«˜åˆ†
            if (score > 10000000) {
                alert('æˆç»©ä¸èƒ½è¶…è¿‡10,000,000ï¼ˆæ»¡åˆ†ï¼‰');
                return;
            }
            
            // æä¾›æˆç»©è¯„çº§å‚è€ƒ
            if (score < 9500000) {
                const confirmLowScore = confirm(`æ‚¨çš„æˆç»©ä¸º ${score.toLocaleString()}ï¼Œè¯„çº§è¾ƒä½ (Dçº§)ã€‚\nç¡®å®šè¦æ·»åŠ è¿™ä¸ªæˆç»©å—ï¼Ÿ`);
                if (!confirmLowScore) {
                    return;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ›²ç›®å’Œéš¾åº¦
            const existingIndex = b30Data.findIndex(item => 
                item.song_id === song && item.difficulty === difficulty
            );
            
            if (existingIndex >= 0) {
                // æ›´æ–°å·²å­˜åœ¨çš„è®°å½•
                b30Data[existingIndex] = {
                    song_id: song,
                    difficulty: difficulty,
                    constant: constant,
                    score: score,
                    single_ptt: calculateSinglePTT(score, constant)
                };
            } else {
                // æ·»åŠ æ–°è®°å½•
                if (b30Data.length >= 30) {
                    alert('B30åˆ—è¡¨å·²æ»¡ï¼Œæœ€å¤šåªèƒ½æ·»åŠ 30é¦–æ­Œæ›²');
                    return;
                }
                
                b30Data.push({
                    song_id: song,
                    difficulty: difficulty,
                    constant: constant,
                    score: score,
                    single_ptt: calculateSinglePTT(score, constant)
                });
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateB30ListDisplay();
            updateB30Stats();
            
            // é‡ç½®è¾“å…¥
            scoreInput.value = '';
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const b30SongsDiv = document.getElementById('b30-songs');
            b30SongsDiv.style.background = 'rgba(76, 175, 80, 0.1)';
            setTimeout(() => {
                b30SongsDiv.style.background = 'white';
            }, 500);
        }
        
        // è®¡ç®—å•æ›²PTT
        function calculateSinglePTT(score, constant) {
            if (score >= 10000000) {
                return constant + 2.0;
            } else if (score >= 9900000) {
                return constant + 1.5 + (score - 9900000) / 100000;
            } else if (score >= 9800000) {
                return constant + 1.0 + (score - 9800000) / 400000;
            } else {
                return Math.max(0, constant + (score - 9500000) / 300000);
            }
        }
        
        // æ›´æ–°B30åˆ—è¡¨æ˜¾ç¤º
        function updateB30ListDisplay() {
            const b30SongsDiv = document.getElementById('b30-songs');
            const b30CountSpan = document.getElementById('b30-count');
            
            if (b30Data.length === 0) {
                b30SongsDiv.innerHTML = 'æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ æˆç»©';
                b30CountSpan.textContent = '0';
                return;
            }
            
            b30CountSpan.textContent = b30Data.length.toString();
            
            // æŒ‰å•æ›²PTTä»é«˜åˆ°ä½æ’åºæ˜¾ç¤º
            const sortedData = [...b30Data].sort((a, b) => b.single_ptt - a.single_ptt);
            
            let html = '';
            sortedData.forEach((item, index) => {
                const grade = getGrade(item.score);
                html += `
                    <div class="b30-song-item">
                        <div class="b30-song-info">
                            <div class="b30-song-name">${item.song_id}</div>
                            <div class="b30-song-details">${item.difficulty.toUpperCase()} (å®šæ•°: ${item.constant.toFixed(1)})</div>
                        </div>
                        <div class="b30-song-score">
                            <div class="b30-song-score-value">${item.score.toLocaleString()}</div>
                            <div class="b30-song-ptt">å•æ›²PTT: ${item.single_ptt.toFixed(2)}</div>
                        </div>
                        <div class="b30-song-actions">
                            <button class="b30-edit-btn" onclick="editB30Item(${index})">ç¼–è¾‘</button>
                            <button class="b30-delete-btn" onclick="deleteFromB30(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            
            b30SongsDiv.innerHTML = html;
        }
        
        // ç¼–è¾‘B30é¡¹ç›®
        function editB30Item(index) {
            // è·å–å®é™…æ’åºåçš„ç´¢å¼•
            const sortedData = [...b30Data].sort((a, b) => b.single_ptt - a.single_ptt);
            const itemToEdit = sortedData[index];
            
            // å¡«å……è¡¨å•
            document.getElementById('selected-song-name').value = itemToEdit.song_id;
            document.getElementById('selected-song').value = itemToEdit.song_id;
            document.getElementById('song-score').value = itemToEdit.score;
            
            // è®¾ç½®éš¾åº¦
            updateDifficultySelect();
            document.getElementById('difficulty-select').value = itemToEdit.difficulty;
            updateConstant();
            
            // æ»šåŠ¨åˆ°è¾“å…¥åŒºåŸŸ
            document.getElementById('b30-mode').scrollIntoView({ behavior: 'smooth' });
            
            // åˆ é™¤åŸè®°å½•
            const actualIndex = b30Data.findIndex(item => 
                item.song_id === itemToEdit.song_id && 
                item.difficulty === itemToEdit.difficulty
            );
            
            if (actualIndex !== -1) {
                b30Data.splice(actualIndex, 1);
                updateB30ListDisplay();
                updateB30Stats();
            }
        }
        
        // ä»B30ä¸­åˆ é™¤
        function deleteFromB30(index) {
            // è·å–è¦åˆ é™¤çš„æ­Œæ›²ä¿¡æ¯ï¼Œç”¨äºæ˜¾ç¤ºåé¦ˆ
            const songToDelete = b30Data[index];
            const songName = songToDelete ? songToDelete.song_id : 'æœªçŸ¥æ­Œæ›²';
            
            b30Data.splice(index, 1);
            updateB30ListDisplay();
            updateB30Stats();
            
            // æ˜¾ç¤ºæ“ä½œåé¦ˆ
            showNotification(`å·²åˆ é™¤æ­Œæ›²: ${songName}`);
        }
        
        // æ¸…ç©ºB30
        function clearB30() {
            // è®°å½•æ¸…ç©ºå‰çš„æ•°é‡ï¼Œç”¨äºæ˜¾ç¤ºåé¦ˆ
            const countBefore = b30Data.length;
            b30Data = [];
            updateB30ListDisplay();
            updateB30Stats();
            
            // æ˜¾ç¤ºæ“ä½œåé¦ˆ
            if (countBefore > 0) {
                showNotification(`å·²æ¸…ç©º ${countBefore} é¦–æ­Œæ›²çš„æˆç»©`);
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
        
        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function confirmClearB30() {
            // åˆ›å»ºå¯¹è¯æ¡†å®¹å™¨
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>ç¡®è®¤æ“ä½œ</h3>
                    <p>ç¡®å®šè¦æ¸…ç©ºB30åˆ—è¡¨å—ï¼Ÿ</p>
                    <div class="confirm-buttons">
                        <button id="confirm-yes" class="confirm-btn confirm-yes">ç¡®å®š</button>
                        <button id="confirm-no" class="confirm-btn confirm-no">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialog);
            
            // è¿”å›Promise
            return new Promise((resolve) => {
                // ç»‘å®šäº‹ä»¶
                document.getElementById('confirm-yes').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                    resolve(true);
                });
                
                document.getElementById('confirm-no').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                    resolve(false);
                });
                
                // ESCé”®å…³é—­å¯¹è¯æ¡†
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        document.removeEventListener('keydown', handleEsc);
                        if (document.body.contains(dialog)) {
                            document.body.removeChild(dialog);
                        }
                        resolve(false);
                    }
                };
                
                document.addEventListener('keydown', handleEsc);
            }).then(result => result);
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const msgElement = document.createElement('div');
            msgElement.className = 'success-message';
            msgElement.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(msgElement);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (document.body.contains(msgElement)) {
                    document.body.removeChild(msgElement);
                }
            }, 3000);
        }
        
        // å¯¼å‡ºB30æ•°æ®
        function exportB30Data() {
            if (b30Data.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            // å‡†å¤‡å¯¼å‡ºæ•°æ®
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                data: b30Data
            };
            
            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `arcaea-b30-${new Date().toISOString().slice(0, 10)}.json`;
            
            // è§¦å‘ä¸‹è½½
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // é‡Šæ”¾URLå¯¹è±¡
            URL.revokeObjectURL(url);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            alert(`æˆåŠŸå¯¼å‡º ${b30Data.length} æ¡B30æ•°æ®`);
        }
        
        // å¯¼å…¥B30æ•°æ®
        function importB30Data(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.json')) {
                alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶');
                event.target.value = '';
                return;
            }
            
            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // è§£æJSONæ•°æ®
                    const importedData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!importedData.data || !Array.isArray(importedData.data)) {
                        alert('æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„B30æ•°æ®æ–‡ä»¶');
                        return;
                    }
                    
                    // ç¡®è®¤å¯¼å…¥
                    const itemCount = importedData.data.length;
                    if (itemCount === 0) {
                        alert('æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„B30æ•°æ®');
                        return;
                    }
                    
                    const confirmImport = confirm(
                        `å³å°†å¯¼å…¥ ${itemCount} æ¡B30æ•°æ®ã€‚` +
                        (b30Data.length > 0 ? '\n\næ³¨æ„ï¼šå¯¼å…¥ä¼šæ¸…ç©ºå½“å‰å·²æœ‰çš„æ•°æ®ã€‚' : '') +
                        '\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
                    );
                    
                    if (!confirmImport) {
                        event.target.value = '';
                        return;
                    }
                    
                    // éªŒè¯æ¯æ¡æ•°æ®çš„å®Œæ•´æ€§
                    const validData = [];
                    for (const item of importedData.data) {
                        if (item.song_id && item.difficulty && item.constant && item.score) {
                            validData.push(item);
                        }
                    }
                    
                    if (validData.length === 0) {
                        alert('æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„B30æ•°æ®');
                        return;
                    }
                    
                    if (validData.length < importedData.data.length) {
                        const skippedCount = importedData.data.length - validData.length;
                        if (!confirm(`éªŒè¯å‘ç° ${skippedCount} æ¡æ— æ•ˆæ•°æ®å°†è¢«è·³è¿‡ï¼Œç»§ç»­å¯¼å…¥ ${validData.length} æ¡æœ‰æ•ˆæ•°æ®å—ï¼Ÿ`)) {
                            event.target.value = '';
                            return;
                        }
                    }
                    
                    // å¯¼å…¥æ•°æ®
                    b30Data = validData;
                    updateB30ListDisplay();
                    updateB30Stats();
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    event.target.value = '';
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    alert(`æˆåŠŸå¯¼å…¥ ${validData.length} æ¡B30æ•°æ®`);
                    
                } catch (error) {
                    console.error('å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:', error);
                    alert('å¯¼å…¥æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                    event.target.value = '';
                }
            };
            
            reader.onerror = function() {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // æ›´æ–°B30ç»Ÿè®¡
        function updateB30Stats() {
            const b30SummaryDiv = document.getElementById('b30-summary');
            
            if (b30Data.length === 0) {
                b30SummaryDiv.style.display = 'none';
                return;
            }
            
            b30SummaryDiv.style.display = 'block';
            
            // è®¡ç®—B30 PTTå¹³å‡å€¼
            const totalPTT = b30Data.reduce((sum, item) => sum + item.single_ptt, 0);
            const b30PTT = totalPTT / b30Data.length;
            
            // è®¡ç®—B10 PTTå¹³å‡å€¼ï¼ˆå–å‰10åæœ€é«˜PTTï¼‰
            const sortedData = [...b30Data].sort((a, b) => b.single_ptt - a.single_ptt);
            const top10Data = sortedData.slice(0, 10);
            const b10TotalPTT = top10Data.reduce((sum, item) => sum + item.single_ptt, 0);
            const b10PTT = b10TotalPTT / Math.min(10, top10Data.length);
            
            // è®¡ç®—åœ°æ¿PTTï¼ˆå–B30ä¸­å•æ›²PTTæœ€ä½çš„é‚£é¦–æ­Œçš„PTTï¼‰
            const sortedByPTT = [...b30Data].sort((a, b) => a.single_ptt - b.single_ptt);
            const floorPTT = sortedByPTT.length > 0 ? sortedByPTT[0].single_ptt : 0;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('b30-ptt').textContent = b30PTT.toFixed(2);
            document.getElementById('b10-ptt').textContent = b10PTT.toFixed(2);
            document.getElementById('floor-ptt').textContent = floorPTT.toFixed(2);
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSongConstants();
            
            // æ·»åŠ åˆ°B30æŒ‰é’®
            const addToB30Btn = document.getElementById('add-to-b30-btn');
            if (addToB30Btn) {
                addToB30Btn.addEventListener('click', function() {
                    console.log('æ·»åŠ åˆ°B30æŒ‰é’®è¢«ç‚¹å‡»');
                    addSongToB30();
                });
            }
            
            // æ¸…ç©ºB30æŒ‰é’®
            const clearB30Btn = document.getElementById('clear-b30-btn');
            if (clearB30Btn) {
                clearB30Btn.addEventListener('click', function() {
                    console.log('æ¸…ç©ºB30æŒ‰é’®è¢«ç‚¹å‡»');
                    clearB30();
                });
            }
        });
        
        // éšè—æœç´¢ç»“æœå’Œéš¾åº¦ä¸‹æ‹‰åˆ—è¡¨å½“ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶
        document.addEventListener('click', function(event) {
            const searchContainer = document.getElementById('song-search').parentNode;
            const difficultyContainer = document.getElementById('difficulty-input').parentNode;
            
            if (!searchContainer.contains(event.target)) {
                document.getElementById('search-results').innerHTML = '';
            }
            
            if (!difficultyContainer.contains(event.target)) {
                document.getElementById('difficulty-results').style.display = 'none';
            }
        });
    </script>
</body>
    <style>
        /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirm-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .confirm-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .confirm-content p {
            margin-bottom: 20px;
            color: #555;
        }
        
        .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .confirm-yes {
            background-color: #e74c3c;
            color: white;
        }
        
        .confirm-yes:hover {
            background-color: #c0392b;
        }
        
        .confirm-no {
            background-color: #95a5a6;
            color: white;
        }
        
        .confirm-no:hover {
            background-color: #7f8c8d;
        }
        
        /* é€šçŸ¥æ¶ˆæ¯æ ·å¼ */
        .notification, .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</html>