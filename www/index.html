<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcaea PTT è®¡ç®—å™¨</title>
    
    <!-- PWA æ”¯æŒ -->
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arcaea PTT">
    <meta name="application-name" content="Arcaea PTT Calculator">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfNSkiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI2IiB5PSI2Ij4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iMiIgZmlsbD0iIzY2N2VlYSIvPgo8dGV4dCB4PSIxMCIgeT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEwIiBmb250LXdlaWdodD0iYm9sZCI+UFQ8L3RleHQ+Cjwvc3ZnPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfNSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPg==">
    
    <!-- å›¾æ ‡æ”¯æŒ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfNSkiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI2IiB5PSI2Ij4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iMiIgZmlsbD0iIzY2N2VlYSIvPgo8dGV4dCB4PSIxMCIgeT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEwIiBmb250LXdlaWdodD0iYm9sZCI+UFQ8L3RleHQ+Cjwvc3ZnPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfNSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPg==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .result-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .result-formula {
            font-size: 12px;
            color: #888;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
        }

        .grade-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .grade-pm { background: #ffd700; color: #333; }
        .grade-ex { background: #87ceeb; color: #333; }
        .grade-uc { background: #98fb98; color: #333; }
        .grade-c { background: #dda0dd; color: #333; }
        .grade-b { background: #f0e68c; color: #333; }
        .grade-a { background: #ffb6c1; color: #333; }
        .grade-d { background: #d3d3d3; color: #333; }
        
        .tolerance-details {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .tolerance-mode-toggle {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            padding: 3px;
        }

        .tolerance-mode-btn {
            flex: 1;
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            margin: 0 1px;
        }

        .tolerance-mode-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.2);
        }

        .tolerance-input-section {
            display: none;
        }

        .tolerance-input-section.active {
            display: block;
        }

        .info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .info-content {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .formula-table {
            width: 100%;
            font-size: 11px;
            margin-top: 10px;
            border-collapse: collapse;
        }

        .formula-table th,
        .formula-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .formula-table th {
            background: rgba(102, 126, 234, 0.1);
            color: #333;
            font-weight: 600;
        }

        .additional-features {
            margin: 25px 0;
            display: flex;
            justify-content: center;
        }

        .feature-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            text-align: center;
            width: 100%;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.1);
        }

        .feature-card h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .feature-card p {
            color: #666;
            font-size: 13px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .feature-btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .feature-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 10px rgba(102, 126, 234, 0.3);
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 25px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .input-section {
            display: none;
        }

        .input-section.active {
            display: block;
        }

        @media (max-width: 480px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .result-value {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ Arcaea PTT è®¡ç®—å™¨</h1>
        <p class="subtitle">åŒå‘è®¡ç®—å·¥å…· - æ”¯æŒPTTä¸æˆç»©äº’è½¬</p>
        
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="switchMode('ptt')">æˆç»©â†’PTT</button>
            <button class="mode-btn" onclick="switchMode('score')">PTTâ†’æˆç»©</button>
            <button class="mode-btn" onclick="switchMode('tolerance')">å®¹é”™è®¡ç®—</button>
        </div>
        
        <!-- æˆç»©è½¬PTTæ¨¡å¼ -->
        <div id="ptt-mode" class="input-section active">
            <div class="input-group">
                <label for="chart-constant-ptt">è°±é¢å®šæ•° (Chart Constant)</label>
                <input type="number" id="chart-constant-ptt" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
            </div>
            
            <div class="input-group">
                <label for="score-ptt">å•æ›²æˆç»© (Score)</label>
                <input type="number" id="score-ptt" step="10000" min="0" max="10000000" placeholder="ä¾‹å¦‚: 9690000" />
            </div>
        </div>
        
        <!-- PTTè½¬æˆç»©æ¨¡å¼ -->
        <div id="score-mode" class="input-section">
            <div class="input-group">
                <label for="chart-constant-score">è°±é¢å®šæ•° (Chart Constant)</label>
                <input type="number" id="chart-constant-score" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
            </div>
            
            <div class="input-group">
                <label for="ptt-score">å•æ›²PTT (Single PTT)</label>
                <input type="number" id="ptt-score" step="0.01" min="0" max="15" placeholder="ä¾‹å¦‚: 11.73" />
            </div>
        </div>
        
        <!-- å®¹é”™è®¡ç®—æ¨¡å¼ -->
        <div id="tolerance-mode" class="input-section">
            <div class="tolerance-mode-toggle">
                <button class="tolerance-mode-btn active" onclick="switchToleranceMode('grade')">è¯„çº§å®¹é”™</button>
                <button class="tolerance-mode-btn" onclick="switchToleranceMode('score')">æˆç»©å®¹é”™</button>
                <button class="tolerance-mode-btn" onclick="switchToleranceMode('ptt')">PTTå®¹é”™</button>
            </div>
            
            <!-- è¯„çº§å®¹é”™æ¨¡å¼ -->
            <div id="grade-tolerance" class="tolerance-input-section active">
                <div class="input-group">
                    <label for="note-count-grade">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-grade" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="target-grade">ç›®æ ‡è¯„çº§ (Target Grade)</label>
                    <select id="target-grade" style="width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; background: white; transition: all 0.3s ease;">
                        <option value="PM">PM (Pure Memory) - 10,000,000åˆ†</option>
                        <option value="EX+">EX+ - 9,900,000åˆ†</option>
                        <option value="EX" selected>EX - 9,800,000åˆ†</option>
                        <option value="UC">UC - 9,700,000åˆ†</option>
                        <option value="C">C - 9,500,000åˆ†</option>
                        <option value="B">B - 9,200,000åˆ†</option>
                        <option value="A">A - 8,900,000åˆ†</option>
                        <option value="D">D - 8,900,000åˆ†ä»¥ä¸‹</option>
                    </select>
                </div>
            </div>
            
            <!-- æˆç»©å®¹é”™æ¨¡å¼ -->
            <div id="score-tolerance" class="tolerance-input-section">
                <div class="input-group">
                    <label for="note-count-score">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-score" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="target-score">ç›®æ ‡æˆç»© (Target Score)</label>
                    <input type="number" id="target-score" step="10000" min="0" max="10000000" placeholder="ä¾‹å¦‚: 9850000" />
                </div>
            </div>
            
            <!-- PTTå®¹é”™æ¨¡å¼ -->
            <div id="ptt-tolerance" class="tolerance-input-section">
                <div class="input-group">
                    <label for="note-count-ptt">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-ptt" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="chart-constant-ptt-tolerance">è°±é¢å®šæ•° (Chart Constant)</label>
                    <input type="number" id="chart-constant-ptt-tolerance" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
                </div>
                
                <div class="input-group">
                    <label for="target-ptt">ç›®æ ‡å•æ›²PTT (Target Single PTT)</label>
                    <input type="number" id="target-ptt" step="0.01" min="0" max="15" placeholder="ä¾‹å¦‚: 11.5" />
                </div>
            </div>
        </div>
        
        <div class="additional-features">
            <div class="feature-card">
                <h3>ğŸ” B30 å›¾ç‰‡åˆ†æ</h3>
                <p>ä¸Šä¼  B30 æˆç»©æˆªå›¾ï¼Œè‡ªåŠ¨æå–æ­Œæ›²å®šæ•°å’Œ PTT ä¿¡æ¯</p>
                <a href="b30-ocr.html" class="feature-btn">å¼€å§‹åˆ†æ</a>
            </div>
        </div>
        
        <div class="result-container" id="result-container">
            <div class="result-label" id="result-label">è®¡ç®—ç»“æœ</div>
            <div class="result-value" id="result-value">-</div>
            <div id="grade-badge"></div>
            <div class="result-formula" id="result-formula">è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—</div>
        </div>
        
        <div class="info-section">
            <div class="info-title">ğŸ“Š PTT è®¡ç®—å…¬å¼</div>
            <div class="info-content">
                <table class="formula-table">
                    <thead>
                        <tr>
                            <th>å¾—åˆ†åŒºé—´</th>
                            <th>è®¡ç®—å…¬å¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>â‰¥ 10,000,000 (PM)</td>
                            <td>å®šæ•° + 2.0</td>
                        </tr>
                        <tr>
                            <td>9,900,000 ~ 9,999,999</td>
                            <td>å®šæ•° + 1.5 + (å¾—åˆ†-9,900,000)/100,000</td>
                        </tr>
                        <tr>
                            <td>9,800,000 ~ 9,899,999</td>
                            <td>å®šæ•° + 1.0 + (å¾—åˆ†-9,800,000)/400,000</td>
                        </tr>
                        <tr>
                            <td>â‰¤ 9,800,000</td>
                            <td>å®šæ•° + (å¾—åˆ†-9,500,000)/300,000</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'ptt';
        let toleranceMode = 'grade';

        function switchMode(mode) {
            currentMode = mode;
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ¢è¾“å…¥åŒºåŸŸ
            document.querySelectorAll('.input-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${mode}-mode`).classList.add('active');
            
            // æ¸…ç©ºç»“æœ
            document.getElementById('result-value').textContent = '-';
            document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—';
            document.getElementById('grade-badge').innerHTML = '';
            
            // æ›´æ–°ç»“æœæ ‡ç­¾
            if (mode === 'ptt') {
                document.getElementById('result-label').textContent = 'å•æ›²PTT';
            } else if (mode === 'score') {
                document.getElementById('result-label').textContent = 'æ‰€éœ€æˆç»©';
            } else {
                document.getElementById('result-label').textContent = 'Farå®¹é”™';
            }
        }

        function calculatePTT(chartConstant, score) {
            let ptt;
            let formula;
            
            if (score >= 10000000) {
                ptt = chartConstant + 2.0;
                formula = `${chartConstant} + 2.0`;
            } else if (score >= 9900000) {
                const bonus = (score - 9900000) / 100000;
                ptt = chartConstant + 1.5 + bonus;
                formula = `${chartConstant} + 1.5 + (${score.toLocaleString()} - 9,900,000)/100,000`;
            } else if (score >= 9800000) {
                const bonus = (score - 9800000) / 400000;
                ptt = chartConstant + 1.0 + bonus;
                formula = `${chartConstant} + 1.0 + (${score.toLocaleString()} - 9,800,000)/400,000`;
            } else {
                const bonus = Math.max(0, (score - 9500000) / 300000);
                ptt = chartConstant + bonus;
                formula = `${chartConstant} + (${score.toLocaleString()} - 9,500,000)/300,000`;
            }
            
            return {
                ptt: Math.max(0, ptt),
                formula: formula,
                grade: getGrade(score)
            };
        }

        function calculateScore(chartConstant, targetPTT) {
            let score;
            let formula;
            let possible = true;
            
            // æ£€æŸ¥ç›®æ ‡PTTæ˜¯å¦å¯èƒ½è¾¾åˆ°
            const maxPTT = chartConstant + 2.0; // PMæ—¶çš„æœ€é«˜PTT
            if (targetPTT > maxPTT) {
                possible = false;
                return {
                    score: 0,
                    formula: `ç›®æ ‡PTT ${targetPTT.toFixed(2)} è¶…è¿‡ç†è®ºæœ€å¤§å€¼ ${maxPTT.toFixed(2)}`,
                    possible: false
                };
            }
            
            const targetBonus = targetPTT - chartConstant;
            
            if (targetBonus >= 2.0) {
                score = 10000000;
                formula = `ç›®æ ‡PTT â‰¥ å®šæ•°+2.0ï¼Œéœ€è¦è¾¾åˆ° PM (10,000,000åˆ†)`;
            } else if (targetBonus >= 1.5) {
                score = 9900000 + (targetBonus - 1.5) * 100000;
                formula = `9900000 + (${targetPTT.toFixed(2)} - ${chartConstant} - 1.5) Ã— 100,000`;
            } else if (targetBonus >= 1.0) {
                score = 9800000 + (targetBonus - 1.0) * 400000;
                formula = `9800000 + (${targetPTT.toFixed(2)} - ${chartConstant} - 1.0) Ã— 400,000`;
            } else if (targetBonus > 0) {
                score = 9500000 + targetBonus * 300000;
                formula = `9500000 + (${targetPTT.toFixed(2)} - ${chartConstant}) Ã— 300,000`;
            } else {
                score = 9500000 + targetBonus * 300000; // å¯èƒ½ä¸ºè´Ÿæ•°
                formula = `9500000 + (${targetPTT.toFixed(2)} - ${chartConstant}) Ã— 300,000`;
            }
            
            // é™åˆ¶åˆ†æ•°èŒƒå›´
            score = Math.max(0, Math.min(10000000, Math.round(score)));
            
            return {
                score: score,
                formula: formula,
                possible: true,
                grade: getGrade(score)
            };
        }
        
        function getGrade(score) {
            if (score >= 10000000) return { name: 'PM', class: 'grade-pm' };
            if (score >= 9900000) return { name: 'EX+', class: 'grade-ex' };
            if (score >= 9800000) return { name: 'EX', class: 'grade-ex' };
            if (score >= 9700000) return { name: 'UC', class: 'grade-uc' };
            if (score >= 9500000) return { name: 'C', class: 'grade-c' };
            if (score >= 9200000) return { name: 'B', class: 'grade-b' };
            if (score >= 8900000) return { name: 'A', class: 'grade-a' };
            return { name: 'D', class: 'grade-d' };
        }
        
        function updateResult() {
            if (currentMode === 'ptt') {
                updatePTTResult();
            } else if (currentMode === 'score') {
                updateScoreResult();
            } else {
                updateToleranceResult();
            }
        }

        function updatePTTResult() {
            const chartConstant = parseFloat(document.getElementById('chart-constant-ptt').value);
            const score = parseInt(document.getElementById('score-ptt').value);
            
            if (isNaN(chartConstant) || isNaN(score)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„å®šæ•°å’Œæˆç»©';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (score < 0 || score > 10000000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'æˆç»©åº”åœ¨ 0-10,000,000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            const result = calculatePTT(chartConstant, score);
            
            document.getElementById('result-value').textContent = result.ptt.toFixed(2);
            document.getElementById('result-formula').textContent = `${result.formula} = ${result.ptt.toFixed(2)}`;
            
            const grade = result.grade;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;
        }

        function updateScoreResult() {
            const chartConstant = parseFloat(document.getElementById('chart-constant-score').value);
            const targetPTT = parseFloat(document.getElementById('ptt-score').value);
            
            if (isNaN(chartConstant) || isNaN(targetPTT)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„å®šæ•°å’ŒPTT';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (targetPTT < 0 || targetPTT > 15) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'PTTåº”åœ¨ 0-15 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            const result = calculateScore(chartConstant, targetPTT);
            
            if (!result.possible) {
                document.getElementById('result-value').textContent = 'ä¸å¯èƒ½';
                document.getElementById('result-formula').textContent = result.formula;
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            document.getElementById('result-value').textContent = result.score.toLocaleString();
            document.getElementById('result-formula').textContent = `${result.formula} = ${result.score.toLocaleString()}`;
            
            const grade = result.grade;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;
        }

        function calculateTolerance(noteCount, targetGrade) {
            const gradeScores = {
                'PM': 10000000,
                'EX+': 9900000,
                'EX': 9800000,
                'UC': 9700000,
                'C': 9500000,
                'B': 9200000,
                'A': 8900000,
                'D': 8899999 // ä½¿ç”¨8899999æ¥è¡¨ç¤ºDè¯„çº§
            };

            const targetScore = gradeScores[targetGrade];
            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;

            let maxFarCount;
            let resultText;

            if (targetGrade === 'PM') {
                // PMéœ€è¦0ä¸ªFarï¼Œå…¨æ˜¯Pure
                maxFarCount = 0;
                resultText = `PMéœ€è¦å…¨Pureåˆ¤å®šï¼Œä¸å…è®¸ä»»ä½•Far`;
            } else if (targetGrade === 'D') {
                // Dè¯„çº§å®¹é”™å¤ªå¤šï¼Œè®¡ç®—åˆ°æ‰€æœ‰Far
                maxFarCount = Math.floor(noteCount * 0.9); // 90%ä¸ºFar
                resultText = `Dè¯„çº§å®¹é”™æå¤§ï¼Œè¿™é‡Œè®¡ç®—90%å®¹é”™`;
            } else {
                // å…¶ä»–è¯„çº§è®¡ç®—æœ€å¤§Faræ•°é‡
                const maxLostScore = 10000000 - targetScore;
                maxFarCount = Math.floor(maxLostScore / farLoss);
                
                // ç¡®ä¿ä¸è¶…è¿‡æ€»Noteæ•°
                maxFarCount = Math.min(maxFarCount, noteCount);
                
                const pureCount = noteCount - maxFarCount;
                const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
                
                resultText = `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†`;
            }

            const pureCount = noteCount - maxFarCount;
            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            return {
                maxFarCount: maxFarCount,
                pureCount: pureCount,
                farPercentage: farPercentage,
                purePercentage: purePercentage,
                targetScore: targetScore,
                resultText: resultText,
                singleNoteScore: singleNoteScore,
                farLoss: farLoss
            };
        }

        function switchToleranceMode(mode) {
            toleranceMode = mode;
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tolerance-mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ¢è¾“å…¥åŒºåŸŸ
            document.querySelectorAll('.tolerance-input-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${mode}-tolerance`).classList.add('active');
            
            // æ¸…ç©ºç»“æœ
            document.getElementById('result-value').textContent = '-';
            document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—';
            document.getElementById('grade-badge').innerHTML = '';
        }

        function updateToleranceResult() {
            if (toleranceMode === 'grade') {
                updateGradeToleranceResult();
            } else if (toleranceMode === 'score') {
                updateScoreToleranceResult();
            } else {
                updatePTTToleranceResult();
            }
        }

        function updateGradeToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-grade').value);
            const targetGrade = document.getElementById('target-grade').value;

            if (isNaN(noteCount) || noteCount <= 0) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const result = calculateTolerance(noteCount, targetGrade);
            
            document.getElementById('result-value').textContent = result.maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge grade-${targetGrade.toLowerCase().replace('+', '')}">${targetGrade}</span>`;

            let detailedInfo = `${result.resultText}\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${result.singleNoteScore.toFixed(2)}åˆ†\n`;
            detailedInfo += `å•ä¸ªFaræŸå¤±: ${result.farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${result.farPercentage}% | Pureéœ€æ±‚ç‡: ${result.purePercentage}%`;

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function updateScoreToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-score').value);
            const targetScore = parseInt(document.getElementById('target-score').value);

            if (isNaN(noteCount) || noteCount <= 0 || isNaN(targetScore)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡å’Œç›®æ ‡æˆç»©';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (targetScore < 0 || targetScore > 10000000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'æˆç»©åº”åœ¨ 0-10,000,000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;
            const maxLostScore = 10000000 - targetScore;
            
            // è®¡ç®—æœ€å¤§Faræ•°é‡
            let maxFarCount = Math.floor(maxLostScore / farLoss);
            maxFarCount = Math.min(maxFarCount, noteCount);
            maxFarCount = Math.max(0, maxFarCount);
            
            const pureCount = noteCount - maxFarCount;
            const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
            const grade = getGrade(targetScore);
            
            // è®¡ç®—è¿˜æœ‰å¤šå°‘åˆ†åˆ°ä¸‹ä¸€ä¸ªè¯„çº§
            const nextGradeScore = getNextGradeScore(targetScore);
            const scoreToNextGrade = nextGradeScore > targetScore ? nextGradeScore - targetScore : 0;
            const farToNextGrade = scoreToNextGrade > 0 ? Math.ceil(scoreToNextGrade / farLoss) : 0;

            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            document.getElementById('result-value').textContent = maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;

            let detailedInfo = `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `ç›®æ ‡æˆç»©: ${targetScore.toLocaleString()}åˆ† | å®é™…å¯è¾¾: ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${singleNoteScore.toFixed(2)}åˆ† | å•ä¸ªFaræŸå¤±: ${farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${farPercentage}% | Pureéœ€æ±‚ç‡: ${purePercentage}%`;
            
            if (scoreToNextGrade > 0 && farToNextGrade > 0) {
                detailedInfo += `\nè·ç¦»ä¸Šä¸€è¯„çº§è¿˜éœ€å‡å°‘ ${farToNextGrade} ä¸ªFar`;
            }

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function updatePTTToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-ptt').value);
            const chartConstant = parseFloat(document.getElementById('chart-constant-ptt-tolerance').value);
            const targetPTT = parseFloat(document.getElementById('target-ptt').value);

            if (isNaN(noteCount) || noteCount <= 0 || isNaN(chartConstant) || isNaN(targetPTT)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡ã€å®šæ•°å’Œç›®æ ‡PTT';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (targetPTT < 0 || targetPTT > 15) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'PTTåº”åœ¨ 0-15 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            // å°†PTTè½¬æ¢ä¸ºå¯¹åº”çš„æˆç»©
            const scoreResult = calculateScore(chartConstant, targetPTT);
            
            if (!scoreResult.possible) {
                document.getElementById('result-value').textContent = 'ä¸å¯èƒ½';
                document.getElementById('result-formula').textContent = scoreResult.formula;
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const targetScore = scoreResult.score;
            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;
            const maxLostScore = 10000000 - targetScore;
            
            // è®¡ç®—æœ€å¤§Faræ•°é‡
            let maxFarCount = Math.floor(maxLostScore / farLoss);
            maxFarCount = Math.min(maxFarCount, noteCount);
            maxFarCount = Math.max(0, maxFarCount);
            
            const pureCount = noteCount - maxFarCount;
            const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
            const grade = getGrade(targetScore);
            
            // è®¡ç®—PTTæå‡ç©ºé—´
            const maxPTT = chartConstant + 2.0;
            const pttToNextLevel = getPTTToNextLevel(targetPTT);

            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            document.getElementById('result-value').textContent = maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;

            let detailedInfo = `ç›®æ ‡PTT ${targetPTT.toFixed(2)} éœ€è¦ ${targetScore.toLocaleString()}åˆ†\n`;
            detailedInfo += `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${singleNoteScore.toFixed(2)}åˆ† | å•ä¸ªFaræŸå¤±: ${farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${farPercentage}% | Pureéœ€æ±‚ç‡: ${purePercentage}%\n`;
            detailedInfo += `è°±é¢æœ€é«˜PTT: ${maxPTT.toFixed(2)} | å½“å‰PTTç›®æ ‡: ${targetPTT.toFixed(2)}`;
            
            if (pttToNextLevel.nextPTT > targetPTT) {
                const farNeededToNext = Math.ceil((pttToNextLevel.scoreNeeded - targetScore) / farLoss);
                detailedInfo += `\nè¾¾åˆ°${pttToNextLevel.nextPTT.toFixed(2)}PTTè¿˜éœ€å‡å°‘${farNeededToNext}ä¸ªFar`;
            }

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function getPTTToNextLevel(currentPTT) {
            // è®¡ç®—ä¸‹ä¸€ä¸ªé‡è¦çš„PTTé‡Œç¨‹ç¢‘ï¼ˆé€šå¸¸æ˜¯æ•´æ•°æˆ–0.5çš„å€æ•°ï¼‰
            const nextMilestone = Math.ceil(currentPTT * 2) / 2; // å‘ä¸Šå–æ•´åˆ°0.5
            if (nextMilestone <= currentPTT) {
                return { nextPTT: currentPTT + 0.5, scoreNeeded: 0 };
            }
            
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„è®¡ç®—
            return { 
                nextPTT: nextMilestone, 
                scoreNeeded: 0 // å®é™…åº”è¯¥è®¡ç®—å¯¹åº”åˆ†æ•°
            };
        }

        function getNextGradeScore(currentScore) {
            if (currentScore >= 10000000) return 10000000;
            if (currentScore >= 9900000) return 10000000;  // EX+ to PM
            if (currentScore >= 9800000) return 9900000;  // EX to EX+
            if (currentScore >= 9700000) return 9800000;  // UC to EX
            if (currentScore >= 9500000) return 9700000;  // C to UC
            if (currentScore >= 9200000) return 9500000;  // B to C
            if (currentScore >= 8900000) return 9200000;  // A to B
            return 8900000;  // Below A to A
        }
        
        // å®æ—¶è®¡ç®—
        document.getElementById('chart-constant-ptt').addEventListener('input', updateResult);
        document.getElementById('score-ptt').addEventListener('input', updateResult);
        document.getElementById('chart-constant-score').addEventListener('input', updateResult);
        document.getElementById('ptt-score').addEventListener('input', updateResult);
        document.getElementById('note-count-grade').addEventListener('input', updateResult);
        document.getElementById('note-count-score').addEventListener('input', updateResult);
        document.getElementById('note-count-ptt').addEventListener('input', updateResult);
        document.getElementById('target-score').addEventListener('input', updateResult);
        document.getElementById('target-ptt').addEventListener('input', updateResult);
        document.getElementById('chart-constant-ptt-tolerance').addEventListener('input', updateResult);
        document.getElementById('target-grade').addEventListener('change', updateResult);
        
        // æ·»åŠ ç¤ºä¾‹è®¡ç®—
        document.getElementById('chart-constant-ptt').value = '11.1';
        document.getElementById('score-ptt').value = '9690000';
        
        // å®¹é”™æ¨¡å¼ç¤ºä¾‹
        document.getElementById('note-count-grade').value = '1200';
        document.getElementById('note-count-score').value = '1200';
        document.getElementById('note-count-ptt').value = '1200';
        document.getElementById('target-score').value = '9850000';
        document.getElementById('chart-constant-ptt-tolerance').value = '11.1';
        document.getElementById('target-ptt').value = '11.5';
        document.getElementById('target-grade').value = 'EX';
        
        updateResult();
    </script>
</body>
</html>