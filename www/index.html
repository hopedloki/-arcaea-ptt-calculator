<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcaea PTT è®¡ç®—å™¨</title>
    
    <!-- PWA æ”¯æŒ -->
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arcaea PTT">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfNSkiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI2IiB5PSI2Ij4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iMiIgZmlsbD0iIzY2N2VlYSIvPgo8dGV4dCB4PSIxMCIgeT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEwIiBmb250LXdlaWdodD0iYm9sZCI+UFQ8L3RleHQ+Cjwvc3ZnPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfNSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPg==">
    
    <!-- å›¾æ ‡æ”¯æŒ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfNSkiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI2IiB5PSI2Ij4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iMiIgZmlsbD0iIzY2N2VlYSIvPgo8dGV4dCB4PSIxMCIgeT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEwIiBmb250LXdlaWdodD0iYm9sZCI+UFQ8L3RleHQ+Cjwvc3ZnPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfNSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPg==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .result-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .result-formula {
            font-size: 12px;
            color: #888;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
        }

        .grade-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .grade-pm { background: #ffd700; color: #333; }
        .grade-ex { background: #87ceeb; color: #333; }
        .grade-uc { background: #98fb98; color: #333; }
        .grade-c { background: #dda0dd; color: #333; }
        .grade-b { background: #f0e68c; color: #333; }
        .grade-a { background: #ffb6c1; color: #333; }
        .grade-d { background: #d3d3d3; color: #333; }
        .grade-aa { background: #add8e6; color: #333; }
        
        .tolerance-details {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .tolerance-mode-toggle {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            padding: 3px;
        }

        .tolerance-mode-btn {
            flex: 1;
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            margin: 0 1px;
        }

        .tolerance-mode-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.2);
        }

        .tolerance-input-section {
            display: none;
        }

        .tolerance-input-section.active {
            display: block;
        }

        .info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .info-content {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .formula-table {
            width: 100%;
            font-size: 11px;
            margin-top: 10px;
            border-collapse: collapse;
        }

        .formula-table th,
        .formula-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .formula-table th {
            background: rgba(102, 126, 234, 0.1);
            color: #333;
            font-weight: 600;
        }



        .mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 25px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .crawler-mode-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .input-section {
            display: none;
        }

        .input-section.active {
            display: block;
        }

        @media (max-width: 480px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .result-value {
                font-size: 28px;
            }
        }

        /* B30/R10æ¨¡å¼æ ·å¼ */
        .search-results {
            position: absolute;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .search-result-item:hover {
            background-color: #f5f7fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
        .custom-select {
            position: relative;
        }
        
        .difficulty-results {
            position: absolute;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        
        .difficulty-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .difficulty-item:hover {
            background-color: #f5f7fa;
        }

        .difficulty-item:last-child {
            border-bottom: none;
        }

        .b30-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .b30-controls-row {
            grid-column: span 2;
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .add-btn, .clear-btn, .export-btn, .import-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .add-btn, .export-btn {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .add-btn:hover, .export-btn:hover {
            background: #5a67d8;
            box-shadow: 0 6px 10px rgba(102, 126, 234, 0.4);
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }
        
        .crawler-btn {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
            box-shadow: 0 2px 5px rgba(230, 126, 34, 0.3);
        }
        
        .crawler-btn:hover {
            background: linear-gradient(135deg, #d35400, #e67e22);
            box-shadow: 0 6px 10px rgba(230, 126, 34, 0.4);
        }

        .clear-btn:hover {
            background: #c0392b;
            box-shadow: 0 6px 10px rgba(231, 76, 60, 0.4);
        }

        .import-btn {
            background: #9b59b6;
            color: white;
            box-shadow: 0 2px 5px rgba(155, 89, 182, 0.3);
        }

        .import-btn:hover {
            background: #8e44ad;
            box-shadow: 0 6px 10px rgba(155, 89, 182, 0.4);
        }



        .b30-list-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .b30-list-container h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .b30-songs {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .b30-song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .b30-song-item:last-child {
            border-bottom: none;
        }

        .b30-song-info {
            flex: 1;
        }

        .b30-song-name {
            font-weight: 600;
            color: #333;
        }

        .b30-song-details {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .b30-song-score {
            text-align: right;
            margin-right: 15px;
        }

        .b30-song-score-value {
            font-weight: 600;
            color: #667eea;
        }

        .b30-song-ptt {
            font-size: 12px;
            color: #888;
        }

        .b30-song-actions {
            display: flex;
            gap: 5px;
        }

        .b30-edit-btn, .b30-delete-btn {
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .b30-edit-btn {
            background: #3498db;
        }

        .b30-edit-btn:hover {
            background: #2980b9;
        }

        .b30-delete-btn {
            background: #e74c3c;
        }

        .b30-delete-btn:hover {
            background: #c0392b;
        }

        .b30-summary {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
        }

        .b30-summary h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .b30-stats {
            display: flex;
            justify-content: space-around;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .input-group {
            position: relative;
        }

        /* R10æ¨¡å¼æ ·å¼ */
        .r10-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .r10-controls-row {
            grid-column: span 2;
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .r10-list-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .r10-list-container h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .r10-songs {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .r10-song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .r10-song-item:last-child {
            border-bottom: none;
        }

        .r10-song-info {
            flex: 1;
        }

        .r10-song-name {
            font-weight: 600;
            color: #333;
        }

        .r10-song-details {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .r10-song-score {
            text-align: right;
            margin-right: 15px;
        }

        .r10-song-score-value {
            font-weight: 600;
            color: #9b59b6;
        }

        .r10-song-ptt {
            font-size: 12px;
            color: #888;
        }

        .r10-song-actions {
            display: flex;
            gap: 5px;
        }

        .r10-edit-btn, .r10-delete-btn {
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .r10-edit-btn {
            background: #3498db;
        }

        .r10-edit-btn:hover {
            background: #2980b9;
        }

        .r10-delete-btn {
            background: #e74c3c;
        }

        .r10-delete-btn:hover {
            background: #c0392b;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 600px) {
            .b30-controls, .r10-controls {
                grid-template-columns: 1fr;
            }
            
            .b30-buttons, .r10-buttons {
                grid-column: span 1;
            }
            
            .b30-stats, .r10-stats {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ Arcaea PTT è®¡ç®—å™¨</h1>
        <p class="subtitle">åŒå‘è®¡ç®—å·¥å…· - æ”¯æŒPTTä¸æˆç»©äº’è½¬</p>
        
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="switchMode('ptt')">æˆç»©â†’PTT</button>
            <button class="mode-btn" onclick="switchMode('score')">PTTâ†’æˆç»©</button>
            <button class="mode-btn" onclick="switchMode('tolerance')">å®¹é”™è®¡ç®—</button>
            <button class="mode-btn" onclick="switchMode('b30')">B30å½•å…¥</button>
            <button class="mode-btn" onclick="switchMode('r10')">R10å½•å…¥</button>
            <button class="mode-btn crawler-mode-btn" onclick="importCrawlerData()">çˆ¬è™«å¯¼å…¥</button>
        </div>
        
        <!-- æˆç»©è½¬PTTæ¨¡å¼ -->
        <div id="ptt-mode" class="input-section active">
            <div class="input-group">
                <label for="chart-constant-ptt">è°±é¢å®šæ•° (Chart Constant)</label>
                <input type="number" id="chart-constant-ptt" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
            </div>
            
            <div class="input-group">
                <label for="score-ptt">å•æ›²æˆç»© (Score)</label>
                <input type="number" id="score-ptt" step="10000" min="0" max="10000000" placeholder="ä¾‹å¦‚: 9690000" />
            </div>
        </div>
        
        <!-- PTTè½¬æˆç»©æ¨¡å¼ -->
        <div id="score-mode" class="input-section">
            <div class="input-group">
                <label for="chart-constant-score">è°±é¢å®šæ•° (Chart Constant)</label>
                <input type="number" id="chart-constant-score" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
            </div>
            
            <div class="input-group">
                <label for="ptt-score">å•æ›²PTT (Single PTT)</label>
                <input type="number" id="ptt-score" step="0.01" min="0" max="15" placeholder="ä¾‹å¦‚: 11.73" />
            </div>
        </div>
        
        <!-- å®¹é”™è®¡ç®—æ¨¡å¼ -->
        <div id="tolerance-mode" class="input-section">
            <div class="tolerance-mode-toggle">
                <button class="tolerance-mode-btn active" onclick="switchToleranceMode('grade')">è¯„çº§å®¹é”™</button>
                <button class="tolerance-mode-btn" onclick="switchToleranceMode('score')">æˆç»©å®¹é”™</button>
                <button class="tolerance-mode-btn" onclick="switchToleranceMode('ptt')">PTTå®¹é”™</button>
            </div>
            
            <!-- è¯„çº§å®¹é”™æ¨¡å¼ -->
            <div id="grade-tolerance" class="tolerance-input-section active">
                <div class="input-group">
                    <label for="note-count-grade">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-grade" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="target-grade">ç›®æ ‡è¯„çº§ (Target Grade)</label>
                    <select id="target-grade" style="width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; background: white; transition: all 0.3s ease;">
                        <option value="PM">PM (Pure Memory) - 10,000,000åˆ†</option>
                        <option value="EX+">EX+ - 9,900,000åˆ†</option>
                        <option value="EX" selected>EX - 9,800,000åˆ†</option>
                        <option value="UC">UC - 9,700,000åˆ†</option>
                        <option value="C">C - 9,500,000åˆ†</option>
                        <option value="B">B - 9,200,000åˆ†</option>
                        <option value="A">A - 8,900,000åˆ†</option>
                        <option value="D">D - 8,900,000åˆ†ä»¥ä¸‹</option>
                    </select>
                </div>
            </div>
            
            <!-- æˆç»©å®¹é”™æ¨¡å¼ -->
            <div id="score-tolerance" class="tolerance-input-section">
                <div class="input-group">
                    <label for="note-count-score">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-score" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="target-score">ç›®æ ‡æˆç»© (Target Score)</label>
                    <input type="number" id="target-score" step="10000" min="0" max="10000000" placeholder="ä¾‹å¦‚: 9850000" />
                </div>
            </div>
            
            <!-- PTTå®¹é”™æ¨¡å¼ -->
            <div id="ptt-tolerance" class="tolerance-input-section">
                <div class="input-group">
                    <label for="note-count-ptt">è°±é¢ç‰©é‡ (Note Count)</label>
                    <input type="number" id="note-count-ptt" step="1" min="1" max="5000" placeholder="ä¾‹å¦‚: 1200" />
                </div>
                
                <div class="input-group">
                    <label for="chart-constant-ptt-tolerance">è°±é¢å®šæ•° (Chart Constant)</label>
                    <input type="number" id="chart-constant-ptt-tolerance" step="0.1" min="0" max="13" placeholder="ä¾‹å¦‚: 11.1" />
                </div>
                
                <div class="input-group">
                    <label for="target-ptt">ç›®æ ‡å•æ›²PTT (Target Single PTT)</label>
                    <input type="number" id="target-ptt" step="0.01" min="0" max="15" placeholder="ä¾‹å¦‚: 11.5" />
                </div>
            </div>
        </div>
        
        <!-- B30å½•å…¥æ¨¡å¼ -->
        <div id="b30-mode" class="input-section">
            <div class="input-group">
                <label for="b30-song-search">æœç´¢æ­Œæ›² (æ­Œåæˆ–å®šæ•°)</label>
                <input type="text" id="b30-song-search" placeholder="è¾“å…¥æ­Œæ›²åç§°æˆ–å®šæ•°æœç´¢" oninput="searchSongs('b30')" />
                <div id="b30-search-results" class="search-results"></div>
            </div>
            
            <div class="b30-controls">
                <div class="input-group">
                    <label for="b30-selected-song-name">å·²é€‰æ‹©æ­Œæ›²</label>
                    <input type="text" id="b30-selected-song-name" readonly placeholder="æœç´¢åè‡ªåŠ¨å¡«å……" />
                    <input type="hidden" id="b30-selected-song" value="" />
                </div>
                
                <div class="input-group">
                    <label for="b30-difficulty-select">é€‰æ‹©éš¾åº¦</label>
                    <div class="custom-select">
                        <input type="text" id="b30-difficulty-input" readonly placeholder="è¯·å…ˆé€‰æ‹©æ­Œæ›²" onclick="toggleDifficultyDropdown('b30')" />
                        <div id="b30-difficulty-results" class="difficulty-results"></div>
                        <input type="hidden" id="b30-difficulty-select" value="" />
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="b30-song-constant">å®šæ•°</label>
                    <input type="number" id="b30-song-constant" step="0.1" min="0" max="13" readonly placeholder="é€‰æ‹©æ­Œæ›²åè‡ªåŠ¨å¡«å……" />
                </div>
                
                <div class="input-group">
                    <label for="b30-song-score">æˆç»© (0-10,000,000)</label>
                    <input type="number" id="b30-song-score" step="10000" min="0" max="10000000" placeholder="è¾“å…¥æˆç»©" />
                </div>
                
                <div class="b30-controls-row">
                    <button class="add-btn" id="add-to-b30-btn">æ·»åŠ åˆ°B30</button>
                    <button class="clear-btn" id="clear-b30-btn">æ¸…ç©ºB30</button>
                </div>
                
                <div class="b30-controls-row">
                    <button class="export-btn" onclick="exportData('b30')">å¯¼å‡ºæ•°æ®</button>
                    <button class="import-btn" onclick="document.getElementById('b30-import-file').click()">å¯¼å…¥æ•°æ®</button>
                    <input type="file" id="b30-import-file" accept=".json" style="display: none;" onchange="importData('b30', event)" />
                    <button class="crawler-btn" onclick="importCrawlerData()">çˆ¬è™«å¯¼å…¥</button>
                </div>
            </div>
            
            <div class="b30-list-container">
                <h3>B30æˆç»©åˆ—è¡¨ (<span id="b30-count">0</span>/30)</h3>
                <div id="b30-songs" class="b30-songs">æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ æˆç»©</div>
                
                <div class="b30-summary" id="b30-summary" style="display: none;">
                    <h4>B30ç»Ÿè®¡</h4>
                    <div class="b30-stats">
                        <div class="stat-item">
                            <div class="stat-label">ç©å®¶PTT</div>
                            <div class="stat-value" id="player-ptt">0.00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">R10 å¹³å‡å€¼</div>
                            <div class="stat-value" id="r10-average-ptt">0.00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åœ°æ¿PTT</div>
                            <div class="stat-value" id="floor-ptt">0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- R10å½•å…¥æ¨¡å¼ -->
        <div id="r10-mode" class="input-section">
            <div class="input-group">
                <label for="r10-song-search">æœç´¢æ­Œæ›² (æ­Œåæˆ–å®šæ•°)</label>
                <input type="text" id="r10-song-search" placeholder="è¾“å…¥æ­Œæ›²åç§°æˆ–å®šæ•°æœç´¢" oninput="searchSongs('r10')" />
                <div id="r10-search-results" class="search-results"></div>
            </div>
            
            <div class="r10-controls">
                <div class="input-group">
                    <label for="r10-selected-song-name">å·²é€‰æ‹©æ­Œæ›²</label>
                    <input type="text" id="r10-selected-song-name" readonly placeholder="æœç´¢åè‡ªåŠ¨å¡«å……" />
                    <input type="hidden" id="r10-selected-song" value="" />
                </div>
                
                <div class="input-group">
                    <label for="r10-difficulty-select">é€‰æ‹©éš¾åº¦</label>
                    <div class="custom-select">
                        <input type="text" id="r10-difficulty-input" readonly placeholder="è¯·å…ˆé€‰æ‹©æ­Œæ›²" onclick="toggleDifficultyDropdown('r10')" />
                        <div id="r10-difficulty-results" class="difficulty-results"></div>
                        <input type="hidden" id="r10-difficulty-select" value="" />
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="r10-song-constant">å®šæ•°</label>
                    <input type="number" id="r10-song-constant" step="0.1" min="0" max="13" readonly placeholder="é€‰æ‹©æ­Œæ›²åè‡ªåŠ¨å¡«å……" />
                </div>
                
                <div class="input-group">
                    <label for="r10-song-score">æˆç»© (0-10,000,000)</label>
                    <input type="number" id="r10-song-score" step="10000" min="0" max="10000000" placeholder="è¾“å…¥æˆç»©" />
                </div>
                
                <div class="r10-controls-row">
                    <button class="add-btn" id="add-to-r10-btn" style="background-color: #9b59b6;">æ·»åŠ åˆ°R10</button>
                    <button class="clear-btn" id="clear-r10-btn">æ¸…ç©ºR10</button>
                </div>
                
                <div class="r10-controls-row">
                    <button class="export-btn" onclick="exportData('r10')" style="background-color: #9b59b6;">å¯¼å‡ºæ•°æ®</button>
                    <button class="import-btn" onclick="document.getElementById('r10-import-file').click()">å¯¼å…¥æ•°æ®</button>
                    <input type="file" id="r10-import-file" accept=".json" style="display: none;" onchange="importData('r10', event)" />
                    <button class="crawler-btn" onclick="importCrawlerData()">çˆ¬è™«å¯¼å…¥</button>
                </div>
            </div>
            
            <div class="r10-list-container">
                <h3>R10æˆç»©åˆ—è¡¨ (<span id="r10-count">0</span>/10)</h3>
                <div id="r10-songs" class="r10-songs">æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ æˆç»©</div>
            </div>
        </div>
        
        <div class="result-container" id="result-container">
            <div class="result-label" id="result-label">è®¡ç®—ç»“æœ</div>
            <div class="result-value" id="result-value">-</div>
            <div id="grade-badge"></div>
            <div class="result-formula" id="result-formula">è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—</div>
        </div>
        
        <div class="info-section">
            <div class="info-title">ğŸ“Š PTT è®¡ç®—å…¬å¼</div>
            <div class="info-content">
                <table class="formula-table">
                    <thead>
                        <tr>
                            <th>å¾—åˆ†åŒºé—´</th>
                            <th>è®¡ç®—å…¬å¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>â‰¥ 10,000,000 (PM)</td>
                            <td>å®šæ•° + 2.0</td>
                        </tr>
                        <tr>
                            <td>9,900,000 ~ 9,999,999</td>
                            <td>å®šæ•° + 1.5 + (å¾—åˆ†-9,900,000)/100,000</td>
                        </tr>
                        <tr>
                            <td>9,800,000 ~ 9,899,999</td>
                            <td>å®šæ•° + 1.0 + (å¾—åˆ†-9,800,000)/400,000</td>
                        </tr>
                        <tr>
                            <td>â‰¤ 9,800,000</td>
                            <td>å®šæ•° + (å¾—åˆ†-9,500,000)/300,000</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'ptt';
        let toleranceMode = 'grade';

        function switchMode(mode) {
            currentMode = mode;
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ¢è¾“å…¥åŒºåŸŸ
            document.querySelectorAll('.input-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${mode}-mode`).classList.add('active');
            
            // æ¸…ç©ºç»“æœ
            document.getElementById('result-value').textContent = '-';
            document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—';
            document.getElementById('grade-badge').innerHTML = '';
            
            // æ›´æ–°ç»“æœæ ‡ç­¾
            if (mode === 'ptt') {
                document.getElementById('result-label').textContent = 'å•æ›²PTT';
            } else if (mode === 'score') {
                document.getElementById('result-label').textContent = 'æ‰€éœ€æˆç»©';
            } else if (mode === 'tolerance') {
                document.getElementById('result-label').textContent = 'Farå®¹é”™';
            } else if (mode === 'b30') {
                document.getElementById('result-label').textContent = 'B30ç®¡ç†';
            } else if (mode === 'r10') {
                document.getElementById('result-label').textContent = 'R10ç®¡ç†';
            }
        }

        function calculatePTT(chartConstant, score) {
            let ptt;
            let formula;
            
            if (score >= 10000000) {
                // PM (Perfect Memory)
                ptt = chartConstant + 2.0;
                formula = `${chartConstant} + 2.0`;
            } else if (score >= 9800000) {
                // 9,800,000 â‰¤ score < 10,000,000: å®šæ•° + 1 + (åˆ†æ•° - 9,800,000)/200,000
                const bonus = (score - 9800000) / 200000;
                ptt = chartConstant + 1.0 + bonus;
                formula = `${chartConstant} + 1.0 + (${score.toLocaleString()} - 9,800,000)/200,000`;
            } else {
                // score < 9,800,000: å®šæ•° + (åˆ†æ•° - 9,500,000)/300,000 (ä¸‹é™ä¸º0)
                const bonus = Math.max(0, (score - 9500000) / 300000);
                ptt = chartConstant + bonus;
                if (score >= 9500000) {
                    formula = `${chartConstant} + (${score.toLocaleString()} - 9,500,000)/300,000`;
                } else {
                    formula = `0 (åˆ†æ•°ä½äº ${Math.max(0, 9500000 - chartConstant * 300000).toLocaleString()})`;
                }
            }
            
            return {
                ptt: Math.max(0, ptt),
                formula: formula,
                grade: getGrade(score)
            };
        }

        function calculateScore(chartConstant, targetPTT) {
            let score;
            let formula;
            let possible = true;
            
            // æ£€æŸ¥ç›®æ ‡PTTæ˜¯å¦å¯èƒ½è¾¾åˆ°
            const maxPTT = chartConstant + 2.0; // PMæ—¶çš„æœ€é«˜PTT
            if (targetPTT > maxPTT) {
                possible = false;
                return {
                    score: 0,
                    formula: `ç›®æ ‡PTT ${targetPTT.toFixed(2)} è¶…è¿‡ç†è®ºæœ€å¤§å€¼ ${maxPTT.toFixed(2)}`,
                    possible: false
                };
            }
            
            const targetBonus = targetPTT - chartConstant;
            
            if (targetBonus >= 2.0) {
                // PM (Perfect Memory)
                score = 10000000;
                formula = `ç›®æ ‡PTT â‰¥ å®šæ•°+2.0ï¼Œéœ€è¦è¾¾åˆ° PM (10,000,000åˆ†)`;
            } else if (targetBonus >= 1.0) {
                // 9,800,000 â‰¤ score < 10,000,000: å®šæ•° + 1 + (åˆ†æ•° - 9,800,000)/200,000
                // åå‘è®¡ç®—: (PTT - å®šæ•° - 1) Ã— 200,000 + 9,800,000
                score = 9800000 + (targetBonus - 1.0) * 200000;
                formula = `9,800,000 + (${targetPTT.toFixed(2)} - ${chartConstant} - 1.0) Ã— 200,000`;
            } else {
                // score < 9,800,000: å®šæ•° + (åˆ†æ•° - 9,500,000)/300,000
                // åå‘è®¡ç®—: (PTT - å®šæ•°) Ã— 300,000 + 9,500,000
                score = 9500000 + targetBonus * 300000;
                if (targetBonus > 0) {
                    formula = `9,500,000 + (${targetPTT.toFixed(2)} - ${chartConstant}) Ã— 300,000`;
                } else {
                    formula = `åˆ†æ•° â‰¤ 9,500,000 - ${chartConstant} Ã— 300,000 = ${Math.max(0, Math.round(9500000 - chartConstant * 300000)).toLocaleString()}`;
                }
            }
            
            // é™åˆ¶åˆ†æ•°èŒƒå›´
            score = Math.max(0, Math.min(10000000, Math.round(score)));
            
            return {
                score: score,
                formula: formula,
                possible: true,
                grade: getGrade(score)
            };
        }
        
        function getGrade(score) {
            if (score >= 10000000) return { name: 'PM', class: 'grade-pm' };
            if (score >= 9900000) return { name: 'EX+', class: 'grade-ex' };
            if (score >= 9800000) return { name: 'EX', class: 'grade-ex' };
            if (score >= 9500000) return { name: 'AA', class: 'grade-aa' };
            if (score >= 9200000) return { name: 'A', class: 'grade-a' };
            if (score >= 8900000) return { name: 'B', class: 'grade-b' };
            if (score >= 8600000) return { name: 'C', class: 'grade-c' };
            return { name: 'D', class: 'grade-d' };
        }
        
        function updateResult() {
            if (currentMode === 'ptt') {
                updatePTTResult();
            } else if (currentMode === 'score') {
                updateScoreResult();
            } else {
                updateToleranceResult();
            }
        }

        function updatePTTResult() {
            const chartConstant = parseFloat(document.getElementById('chart-constant-ptt').value);
            const score = parseInt(document.getElementById('score-ptt').value);
            
            if (isNaN(chartConstant) || isNaN(score)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„å®šæ•°å’Œæˆç»©';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (score < 0 || score > 10000000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'æˆç»©åº”åœ¨ 0-10,000,000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            const result = calculatePTT(chartConstant, score);
            
            document.getElementById('result-value').textContent = result.ptt.toFixed(2);
            document.getElementById('result-formula').textContent = `${result.formula} = ${result.ptt.toFixed(2)}`;
            
            const grade = result.grade;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;
        }

        function updateScoreResult() {
            const chartConstant = parseFloat(document.getElementById('chart-constant-score').value);
            const targetPTT = parseFloat(document.getElementById('ptt-score').value);
            
            if (isNaN(chartConstant) || isNaN(targetPTT)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„å®šæ•°å’ŒPTT';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            if (targetPTT < 0 || targetPTT > 15) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'PTTåº”åœ¨ 0-15 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            const result = calculateScore(chartConstant, targetPTT);
            
            if (!result.possible) {
                document.getElementById('result-value').textContent = 'ä¸å¯èƒ½';
                document.getElementById('result-formula').textContent = result.formula;
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }
            
            document.getElementById('result-value').textContent = result.score.toLocaleString();
            document.getElementById('result-formula').textContent = `${result.formula} = ${result.score.toLocaleString()}`;
            
            const grade = result.grade;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;
        }

        function calculateTolerance(noteCount, targetGrade) {
            const gradeScores = {
                'PM': 10000000,
                'EX+': 9900000,
                'EX': 9800000,
                'UC': 9700000,
                'C': 9500000,
                'B': 9200000,
                'A': 8900000,
                'D': 8899999 // ä½¿ç”¨8899999æ¥è¡¨ç¤ºDè¯„çº§
            };

            const targetScore = gradeScores[targetGrade];
            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;

            let maxFarCount;
            let resultText;

            if (targetGrade === 'PM') {
                // PMéœ€è¦0ä¸ªFarï¼Œå…¨æ˜¯Pure
                maxFarCount = 0;
                resultText = `PMéœ€è¦å…¨Pureåˆ¤å®šï¼Œä¸å…è®¸ä»»ä½•Far`;
            } else if (targetGrade === 'D') {
                // Dè¯„çº§å®¹é”™å¤ªå¤šï¼Œè®¡ç®—åˆ°æ‰€æœ‰Far
                maxFarCount = Math.floor(noteCount * 0.9); // 90%ä¸ºFar
                resultText = `Dè¯„çº§å®¹é”™æå¤§ï¼Œè¿™é‡Œè®¡ç®—90%å®¹é”™`;
            } else {
                // å…¶ä»–è¯„çº§è®¡ç®—æœ€å¤§Faræ•°é‡
                const maxLostScore = 10000000 - targetScore;
                maxFarCount = Math.floor(maxLostScore / farLoss);
                
                // ç¡®ä¿ä¸è¶…è¿‡æ€»Noteæ•°
                maxFarCount = Math.min(maxFarCount, noteCount);
                
                const pureCount = noteCount - maxFarCount;
                const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
                
                resultText = `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†`;
            }

            const pureCount = noteCount - maxFarCount;
            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            return {
                maxFarCount: maxFarCount,
                pureCount: pureCount,
                farPercentage: farPercentage,
                purePercentage: purePercentage,
                targetScore: targetScore,
                resultText: resultText,
                singleNoteScore: singleNoteScore,
                farLoss: farLoss
            };
        }

        function switchToleranceMode(mode) {
            toleranceMode = mode;
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tolerance-mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ¢è¾“å…¥åŒºåŸŸ
            document.querySelectorAll('.tolerance-input-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${mode}-tolerance`).classList.add('active');
            
            // æ¸…ç©ºç»“æœ
            document.getElementById('result-value').textContent = '-';
            document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æ•°æ®å¼€å§‹è®¡ç®—';
            document.getElementById('grade-badge').innerHTML = '';
        }

        function updateToleranceResult() {
            if (toleranceMode === 'grade') {
                updateGradeToleranceResult();
            } else if (toleranceMode === 'score') {
                updateScoreToleranceResult();
            } else {
                updatePTTToleranceResult();
            }
        }

        function updateGradeToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-grade').value);
            const targetGrade = document.getElementById('target-grade').value;

            if (isNaN(noteCount) || noteCount <= 0) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const result = calculateTolerance(noteCount, targetGrade);
            
            document.getElementById('result-value').textContent = result.maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge grade-${targetGrade.toLowerCase().replace('+', '')}">${targetGrade}</span>`;

            let detailedInfo = `${result.resultText}\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${result.singleNoteScore.toFixed(2)}åˆ†\n`;
            detailedInfo += `å•ä¸ªFaræŸå¤±: ${result.farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${result.farPercentage}% | Pureéœ€æ±‚ç‡: ${result.purePercentage}%`;

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function updateScoreToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-score').value);
            const targetScore = parseInt(document.getElementById('target-score').value);

            if (isNaN(noteCount) || noteCount <= 0 || isNaN(targetScore)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡å’Œç›®æ ‡æˆç»©';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (targetScore < 0 || targetScore > 10000000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'æˆç»©åº”åœ¨ 0-10,000,000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;
            const maxLostScore = 10000000 - targetScore;
            
            // è®¡ç®—æœ€å¤§Faræ•°é‡
            let maxFarCount = Math.floor(maxLostScore / farLoss);
            maxFarCount = Math.min(maxFarCount, noteCount);
            maxFarCount = Math.max(0, maxFarCount);
            
            const pureCount = noteCount - maxFarCount;
            const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
            const grade = getGrade(targetScore);
            
            // è®¡ç®—è¿˜æœ‰å¤šå°‘åˆ†åˆ°ä¸‹ä¸€ä¸ªè¯„çº§
            const nextGradeScore = getNextGradeScore(targetScore);
            const scoreToNextGrade = nextGradeScore > targetScore ? nextGradeScore - targetScore : 0;
            const farToNextGrade = scoreToNextGrade > 0 ? Math.ceil(scoreToNextGrade / farLoss) : 0;

            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            document.getElementById('result-value').textContent = maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;

            let detailedInfo = `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `ç›®æ ‡æˆç»©: ${targetScore.toLocaleString()}åˆ† | å®é™…å¯è¾¾: ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${singleNoteScore.toFixed(2)}åˆ† | å•ä¸ªFaræŸå¤±: ${farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${farPercentage}% | Pureéœ€æ±‚ç‡: ${purePercentage}%`;
            
            if (scoreToNextGrade > 0 && farToNextGrade > 0) {
                detailedInfo += `\nè·ç¦»ä¸Šä¸€è¯„çº§è¿˜éœ€å‡å°‘ ${farToNextGrade} ä¸ªFar`;
            }

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function updatePTTToleranceResult() {
            const noteCount = parseInt(document.getElementById('note-count-ptt').value);
            const chartConstant = parseFloat(document.getElementById('chart-constant-ptt-tolerance').value);
            const targetPTT = parseFloat(document.getElementById('target-ptt').value);

            if (isNaN(noteCount) || noteCount <= 0 || isNaN(chartConstant) || isNaN(targetPTT)) {
                document.getElementById('result-value').textContent = '-';
                document.getElementById('result-formula').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç‰©é‡ã€å®šæ•°å’Œç›®æ ‡PTT';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (noteCount > 5000) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'ç‰©é‡åº”åœ¨ 1-5000 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (chartConstant < 0 || chartConstant > 13) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'å®šæ•°åº”åœ¨ 0-13 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            if (targetPTT < 0 || targetPTT > 15) {
                document.getElementById('result-value').textContent = 'é”™è¯¯';
                document.getElementById('result-formula').textContent = 'PTTåº”åœ¨ 0-15 èŒƒå›´å†…';
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            // å°†PTTè½¬æ¢ä¸ºå¯¹åº”çš„æˆç»©
            const scoreResult = calculateScore(chartConstant, targetPTT);
            
            if (!scoreResult.possible) {
                document.getElementById('result-value').textContent = 'ä¸å¯èƒ½';
                document.getElementById('result-formula').textContent = scoreResult.formula;
                document.getElementById('grade-badge').innerHTML = '';
                return;
            }

            const targetScore = scoreResult.score;
            const singleNoteScore = 10000000 / noteCount;
            const farLoss = singleNoteScore * 0.5;
            const maxLostScore = 10000000 - targetScore;
            
            // è®¡ç®—æœ€å¤§Faræ•°é‡
            let maxFarCount = Math.floor(maxLostScore / farLoss);
            maxFarCount = Math.min(maxFarCount, noteCount);
            maxFarCount = Math.max(0, maxFarCount);
            
            const pureCount = noteCount - maxFarCount;
            const actualScore = (pureCount * singleNoteScore) + (maxFarCount * farLoss);
            const grade = getGrade(targetScore);
            
            // è®¡ç®—PTTæå‡ç©ºé—´
            const maxPTT = chartConstant + 2.0;
            const pttToNextLevel = getPTTToNextLevel(targetPTT);

            const farPercentage = ((maxFarCount / noteCount) * 100).toFixed(1);
            const purePercentage = ((pureCount / noteCount) * 100).toFixed(1);

            document.getElementById('result-value').textContent = maxFarCount;
            document.getElementById('grade-badge').innerHTML = 
                `<span class="grade-badge ${grade.class}">${grade.name}</span>`;

            let detailedInfo = `ç›®æ ‡PTT ${targetPTT.toFixed(2)} éœ€è¦ ${targetScore.toLocaleString()}åˆ†\n`;
            detailedInfo += `${maxFarCount}ä¸ªFar + ${pureCount}ä¸ªPure = ${Math.round(actualScore).toLocaleString()}åˆ†\n`;
            detailedInfo += `å•NoteåŸºç¡€åˆ†: ${singleNoteScore.toFixed(2)}åˆ† | å•ä¸ªFaræŸå¤±: ${farLoss.toFixed(2)}åˆ†\n`;
            detailedInfo += `Farå®¹é”™ç‡: ${farPercentage}% | Pureéœ€æ±‚ç‡: ${purePercentage}%\n`;
            detailedInfo += `è°±é¢æœ€é«˜PTT: ${maxPTT.toFixed(2)} | å½“å‰PTTç›®æ ‡: ${targetPTT.toFixed(2)}`;
            
            if (pttToNextLevel.nextPTT > targetPTT) {
                const farNeededToNext = Math.ceil((pttToNextLevel.scoreNeeded - targetScore) / farLoss);
                detailedInfo += `\nè¾¾åˆ°${pttToNextLevel.nextPTT.toFixed(2)}PTTè¿˜éœ€å‡å°‘${farNeededToNext}ä¸ªFar`;
            }

            document.getElementById('result-formula').innerHTML = `<div class="tolerance-details">${detailedInfo}</div>`;
        }

        function getPTTToNextLevel(currentPTT) {
            // è®¡ç®—ä¸‹ä¸€ä¸ªé‡è¦çš„PTTé‡Œç¨‹ç¢‘ï¼ˆé€šå¸¸æ˜¯æ•´æ•°æˆ–0.5çš„å€æ•°ï¼‰
            const nextMilestone = Math.ceil(currentPTT * 2) / 2; // å‘ä¸Šå–æ•´åˆ°0.5
            if (nextMilestone <= currentPTT) {
                return { nextPTT: currentPTT + 0.5, scoreNeeded: 0 };
            }
            
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„è®¡ç®—
            return { 
                nextPTT: nextMilestone, 
                scoreNeeded: 0 // å®é™…åº”è¯¥è®¡ç®—å¯¹åº”åˆ†æ•°
            };
        }

        function getNextGradeScore(currentScore) {
            if (currentScore >= 10000000) return 10000000;
            if (currentScore >= 9900000) return 10000000;  // EX+ to PM
            if (currentScore >= 9800000) return 9900000;  // EX to EX+
            if (currentScore >= 9700000) return 9800000;  // UC to EX
            if (currentScore >= 9500000) return 9700000;  // C to UC
            if (currentScore >= 9200000) return 9500000;  // B to C
            if (currentScore >= 8900000) return 9200000;  // A to B
            return 8900000;  // Below A to A
        }
        
        // å®æ—¶è®¡ç®—
        document.getElementById('chart-constant-ptt').addEventListener('input', updateResult);
        document.getElementById('score-ptt').addEventListener('input', updateResult);
        document.getElementById('chart-constant-score').addEventListener('input', updateResult);
        document.getElementById('ptt-score').addEventListener('input', updateResult);
        document.getElementById('note-count-grade').addEventListener('input', updateResult);
        document.getElementById('note-count-score').addEventListener('input', updateResult);
        document.getElementById('note-count-ptt').addEventListener('input', updateResult);
        document.getElementById('target-score').addEventListener('input', updateResult);
        document.getElementById('target-ptt').addEventListener('input', updateResult);
        document.getElementById('chart-constant-ptt-tolerance').addEventListener('input', updateResult);
        document.getElementById('target-grade').addEventListener('change', updateResult);
        
        // æ·»åŠ ç¤ºä¾‹è®¡ç®—
        document.getElementById('chart-constant-ptt').value = '11.1';
        document.getElementById('score-ptt').value = '9690000';
        
        // å®¹é”™æ¨¡å¼ç¤ºä¾‹
        document.getElementById('note-count-grade').value = '1200';
        document.getElementById('note-count-score').value = '1200';
        document.getElementById('note-count-ptt').value = '1200';
        document.getElementById('target-score').value = '9850000';
        document.getElementById('chart-constant-ptt-tolerance').value = '11.1';
        document.getElementById('target-ptt').value = '11.5';
        document.getElementById('target-grade').value = 'EX';
        
        updateResult();
        
        // B30/R30å½•å…¥åŠŸèƒ½
        let songConstants = {}; // ç”¨äºå­˜å‚¨æ­Œæ›²å®šæ•°æ•°æ®
        let b30Data = []; // ç”¨äºå­˜å‚¨B30æˆç»©æ•°æ®
        let r10Data = []; // ç”¨äºå­˜å‚¨R10æˆç»©æ•°æ®
        
        // åŠ è½½æ­Œæ›²å®šæ•°æ•°æ®
        async function loadSongConstants() {
            try {
                const response = await fetch('./song-constants.json');
                songConstants = await response.json();
                console.log('æ­Œæ›²å®šæ•°æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(songConstants).length, 'é¦–æ­Œæ›²');
            } catch (error) {
                console.error('åŠ è½½æ­Œæ›²å®šæ•°æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // æœç´¢æ­Œæ›²
        function searchSongs(mode) {
            const searchTerm = document.getElementById(`${mode}-song-search`).value.toLowerCase().trim();
            const searchResults = document.getElementById(`${mode}-search-results`);
            
            console.log('æœç´¢è¯:', searchTerm);
            console.log('æ­Œæ›²æ•°æ®æ€»æ•°:', Object.keys(songConstants).length);
            
            if (searchTerm.length < 1) {
                searchResults.innerHTML = '';
                return;
            }
            
            let results = [];
            
            // æœç´¢æ­Œå
            for (const songName in songConstants) {
                if (songName.toLowerCase().includes(searchTerm)) {
                    results.push({ name: songName, type: 'name' });
                }
            }
            
            // æœç´¢å®šæ•°
            const searchConstant = parseFloat(searchTerm);
            if (!isNaN(searchConstant)) {
                for (const songName in songConstants) {
                    const difficulties = songConstants[songName];
                    for (const diff in difficulties) {
                        if (difficulties[diff] !== null && Math.abs(difficulties[diff] - searchConstant) < 0.01) {
                            if (!results.find(r => r.name === songName)) {
                                results.push({ name: songName, type: 'constant', constant: searchConstant });
                            }
                            break;
                        }
                    }
                }
            }
            
            // é™åˆ¶ç»“æœæ•°é‡
            if (results.length > 10) {
                results = results.slice(0, 10);
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            displaySearchResults(results, mode);
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results, mode) {
            const searchResults = document.getElementById(`${mode}-search-results`);
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²</div>';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                const displayText = result.type === 'constant' 
                    ? `${result.name} (å®šæ•°: ${result.constant})` 
                    : result.name;
                html += `<div class="search-result-item" onclick="selectSong('${result.name}', '${mode}')">${displayText}</div>`;
            });
            
            searchResults.innerHTML = html;
        }
        
        // é€‰æ‹©æ­Œæ›²
        function selectSong(songName, mode) {
            document.getElementById(`${mode}-song-search`).value = songName;
            document.getElementById(`${mode}-selected-song-name`).value = songName;
            document.getElementById(`${mode}-selected-song`).value = songName;
            document.getElementById(`${mode}-search-results`).innerHTML = '';
            updateDifficultySelect(mode);
        }
        
        // æ›´æ–°éš¾åº¦é€‰æ‹©
        function updateDifficultySelect(mode) {
            const selectedSongInput = document.getElementById(`${mode}-selected-song`);
            const difficultyInput = document.getElementById(`${mode}-difficulty-input`);
            const difficultySelect = document.getElementById(`${mode}-difficulty-select`);
            const difficultyResults = document.getElementById(`${mode}-difficulty-results`);
            const constantInput = document.getElementById(`${mode}-song-constant`);
            
            // æ¸…ç©ºéš¾åº¦é€‰æ‹©
            difficultyInput.value = 'è¯·é€‰æ‹©éš¾åº¦';
            difficultySelect.value = '';
            difficultyResults.innerHTML = '';
            constantInput.value = '';
            
            // è·å–é€‰ä¸­çš„æ­Œæ›²
            const selectedSong = selectedSongInput.value;
            console.log('æ›´æ–°éš¾åº¦é€‰æ‹©ï¼Œå½“å‰æ­Œæ›²:', selectedSong);
            
            if (!selectedSong || !songConstants[selectedSong]) {
                difficultyInput.value = 'è¯·å…ˆé€‰æ‹©æ­Œæ›²';
                console.log('æœªæ‰¾åˆ°æ­Œæ›²æ•°æ®æˆ–æœªé€‰æ‹©æ­Œæ›²');
                return;
            }
            
            const difficulties = songConstants[selectedSong];
            const difficultyOrder = ['byd', 'ftr', 'prs', 'pst', 'etr'];
            
            // æŒ‰éš¾åº¦é¡ºåºæ·»åŠ é€‰é¡¹
            let html = '';
            difficultyOrder.forEach(diff => {
                const constant = difficulties[diff];
                if (constant !== null && constant !== undefined) {
                    html += `<div class="difficulty-item" onclick="selectDifficulty('${diff}', '${diff.toUpperCase()} (${constant.toFixed(1)})', '${mode}')">${diff.toUpperCase()} (${constant.toFixed(1)})</div>`;
                }
            });
            
            difficultyResults.innerHTML = html;
            
            // å¦‚æœæœ‰å·²é€‰æ‹©çš„éš¾åº¦ï¼Œæ˜¾ç¤ºå®ƒ
            if (difficultySelect.value) {
                const selectedDifficulty = difficultySelect.value;
                const constant = difficulties[selectedDifficulty];
                if (constant !== null && constant !== undefined) {
                    difficultyInput.value = `${selectedDifficulty.toUpperCase()} (${constant.toFixed(1)})`;
                }
            } else {
                difficultyInput.value = 'ç‚¹å‡»é€‰æ‹©éš¾åº¦';
            }
        }
        
        // åˆ‡æ¢éš¾åº¦ä¸‹æ‹‰åˆ—è¡¨
        function toggleDifficultyDropdown(mode) {
            const difficultyResults = document.getElementById(`${mode}-difficulty-results`);
            const isHidden = difficultyResults.style.display === 'none';
            
            // å…³é—­æ‰€æœ‰ä¸‹æ‹‰åˆ—è¡¨
            document.getElementById('b30-difficulty-results').style.display = 'none';
            document.getElementById('r10-difficulty-results').style.display = 'none';
            document.getElementById('b30-search-results').innerHTML = '';
            document.getElementById('r10-search-results').innerHTML = '';
            
            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰åˆ—è¡¨
            if (isHidden && document.getElementById(`${mode}-difficulty-input`).value !== 'è¯·å…ˆé€‰æ‹©æ­Œæ›²') {
                difficultyResults.style.display = 'block';
            }
        }
        
        // é€‰æ‹©éš¾åº¦
        function selectDifficulty(difficulty, displayText, mode) {
            document.getElementById(`${mode}-difficulty-input`).value = displayText;
            document.getElementById(`${mode}-difficulty-select`).value = difficulty;
            document.getElementById(`${mode}-difficulty-results`).style.display = 'none';
            updateConstant(mode);
        }
        
        // æ›´æ–°å®šæ•°
        function updateConstant(mode) {
            const selectedSongInput = document.getElementById(`${mode}-selected-song`);
            const difficultySelect = document.getElementById(`${mode}-difficulty-select`);
            const constantInput = document.getElementById(`${mode}-song-constant`);
            
            const selectedSong = selectedSongInput.value;
            const selectedDifficulty = difficultySelect.value;
            
            if (!selectedSong || !selectedDifficulty || !songConstants[selectedSong]) {
                constantInput.value = '';
                return;
            }
            
            const constant = songConstants[selectedSong][selectedDifficulty];
            if (constant !== null && constant !== undefined) {
                constantInput.value = constant.toFixed(1);
            } else {
                constantInput.value = '';
            }
        }
        
        // æ·»åŠ æ­Œæ›²åˆ°B30
        function addSongToList(mode) {
            console.log(`addSongToList å‡½æ•°è¢«è°ƒç”¨ï¼Œæ¨¡å¼: ${mode}`);
            
            const selectedSongInput = document.getElementById(`${mode}-selected-song`);
            const difficultySelect = document.getElementById(`${mode}-difficulty-select`);
            const constantInput = document.getElementById(`${mode}-song-constant`);
            const scoreInput = document.getElementById(`${mode}-song-score`);
            
            const song = selectedSongInput.value;
            const difficulty = difficultySelect.value;
            const constant = parseFloat(constantInput.value);
            const score = parseInt(scoreInput.value);
            
            console.log('è¾“å…¥å€¼:', { song, difficulty, constant, score });
            
            if (!song || !difficulty || isNaN(constant) || isNaN(score)) {
                alert('è¯·å®Œæ•´å¡«å†™æ›²ç›®ã€éš¾åº¦ã€å®šæ•°å’Œæˆç»©');
                return;
            }
            
            if (score < 0 || score > 10000000) {
                alert('æˆç»©åº”åœ¨ 0-10,000,000 èŒƒå›´å†…');
                return;
            }
            
            // æ£€æŸ¥æˆç»©æ˜¯å¦è¶…è¿‡æœ€é«˜åˆ†
            if (score > 10000000) {
                alert('æˆç»©ä¸èƒ½è¶…è¿‡10,000,000ï¼ˆæ»¡åˆ†ï¼‰');
                return;
            }
            
            // æä¾›æˆç»©è¯„çº§å‚è€ƒ
            if (score < 9500000) {
                const confirmLowScore = confirm(`æ‚¨çš„æˆç»©ä¸º ${score.toLocaleString()}ï¼Œè¯„çº§è¾ƒä½ (Dçº§)ã€‚\nç¡®å®šè¦æ·»åŠ è¿™ä¸ªæˆç»©å—ï¼Ÿ`);
                if (!confirmLowScore) {
                    return;
                }
            }
            
            let data;
            let maxCount;
            let listElement;
            let countElement;
            
            if (mode === 'b30') {
                data = b30Data;
                maxCount = 30;
                listElement = 'b30-songs';
                countElement = 'b30-count';
            } else if (mode === 'r10') {
                data = r10Data;
                maxCount = 10;
                listElement = 'r10-songs';
                countElement = 'r10-count';
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ›²ç›®å’Œéš¾åº¦
            const existingIndex = data.findIndex(item => 
                item.song_id === song && item.difficulty === difficulty
            );
            
            if (existingIndex >= 0) {
                // æ›´æ–°å·²å­˜åœ¨çš„è®°å½•
                data[existingIndex] = {
                    song_id: song,
                    difficulty: difficulty,
                    constant: constant,
                    score: score,
                    single_ptt: calculateSinglePTT(score, constant)
                };
            } else {
                // æ·»åŠ æ–°è®°å½•
                if (data.length >= maxCount) {
                    alert(`${mode.toUpperCase()}åˆ—è¡¨å·²æ»¡ï¼Œæœ€å¤šåªèƒ½æ·»åŠ ${maxCount}é¦–æ­Œæ›²`);
                    return;
                }
                
                data.push({
                    song_id: song,
                    difficulty: difficulty,
                    constant: constant,
                    score: score,
                    single_ptt: calculateSinglePTT(score, constant)
                });
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateListDisplay(mode);
            updateStats();
            
            // é‡ç½®è¾“å…¥
            scoreInput.value = '';
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const songsDiv = document.getElementById(listElement);
            songsDiv.style.background = mode === 'b30' ? 'rgba(76, 175, 80, 0.1)' : 'rgba(155, 89, 182, 0.1)';
            setTimeout(() => {
                songsDiv.style.background = 'white';
            }, 500);
        }
        
        // è®¡ç®—å•æ›²PTT
        function calculateSinglePTT(score, constant) {
            if (score >= 10000000) {
                return constant + 2.0;
            } else if (score >= 9900000) {
                return constant + 1.5 + (score - 9900000) / 100000;
            } else if (score >= 9800000) {
                return constant + 1.0 + (score - 9800000) / 400000;
            } else {
                return Math.max(0, constant + (score - 9500000) / 300000);
            }
        }
        
        // æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
        function updateListDisplay(mode) {
            const data = mode === 'b30' ? b30Data : r10Data;
            const songsDiv = document.getElementById(`${mode}-songs`);
            const countSpan = document.getElementById(`${mode}-count`);
            
            if (data.length === 0) {
                songsDiv.innerHTML = 'æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ æˆç»©';
                countSpan.textContent = '0';
                return;
            }
            
            countSpan.textContent = data.length.toString();
            
            // æŒ‰å•æ›²PTTä»é«˜åˆ°ä½æ’åºæ˜¾ç¤º
            const sortedData = [...data].sort((a, b) => b.single_ptt - a.single_ptt);
            
            let html = '';
            sortedData.forEach((item, index) => {
                const grade = getGrade(item.score);
                const colorClass = mode === 'b30' ? 'b30' : 'r10';
                html += `
                    <div class="${colorClass}-song-item">
                        <div class="${colorClass}-song-info">
                            <div class="${colorClass}-song-name">${item.song_id}</div>
                            <div class="${colorClass}-song-details">${item.difficulty.toUpperCase()} (å®šæ•°: ${item.constant.toFixed(1)})</div>
                        </div>
                        <div class="${colorClass}-song-score">
                            <div class="${colorClass}-song-score-value">${item.score.toLocaleString()}</div>
                            <div class="${colorClass}-song-ptt">å•æ›²PTT: ${item.single_ptt.toFixed(2)}</div>
                        </div>
                        <div class="${colorClass}-song-actions">
                            <button class="${colorClass}-edit-btn" onclick="editItem('${mode}', ${index})">ç¼–è¾‘</button>
                            <button class="${colorClass}-delete-btn" onclick="deleteFromList('${mode}', ${index})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            
            songsDiv.innerHTML = html;
        }
        
        // ç¼–è¾‘åˆ—è¡¨é¡¹ç›®
        function editItem(mode, index) {
            const data = mode === 'b30' ? b30Data : r10Data;
            // è·å–å®é™…æ’åºåçš„ç´¢å¼•
            const sortedData = [...data].sort((a, b) => b.single_ptt - a.single_ptt);
            const itemToEdit = sortedData[index];
            
            // å¡«å……è¡¨å•
            document.getElementById(`${mode}-selected-song-name`).value = itemToEdit.song_id;
            document.getElementById(`${mode}-selected-song`).value = itemToEdit.song_id;
            document.getElementById(`${mode}-song-score`).value = itemToEdit.score;
            
            // è®¾ç½®éš¾åº¦
            updateDifficultySelect(mode);
            document.getElementById(`${mode}-difficulty-select`).value = itemToEdit.difficulty;
            updateConstant(mode);
            
            // æ»šåŠ¨åˆ°è¾“å…¥åŒºåŸŸ
            document.getElementById(`${mode}-mode`).scrollIntoView({ behavior: 'smooth' });
            
            // åˆ é™¤åŸè®°å½•
            const actualIndex = data.findIndex(item => 
                item.song_id === itemToEdit.song_id && 
                item.difficulty === itemToEdit.difficulty
            );
            
            if (actualIndex !== -1) {
                data.splice(actualIndex, 1);
                updateListDisplay(mode);
                updateStats();
            }
        }
        
        // ä»åˆ—è¡¨ä¸­åˆ é™¤
        function deleteFromList(mode, index) {
            const data = mode === 'b30' ? b30Data : r10Data;
            // è·å–è¦åˆ é™¤çš„æ­Œæ›²ä¿¡æ¯ï¼Œç”¨äºæ˜¾ç¤ºåé¦ˆ
            const songToDelete = data[index];
            const songName = songToDelete ? songToDelete.song_id : 'æœªçŸ¥æ­Œæ›²';
            
            data.splice(index, 1);
            updateListDisplay(mode);
            updateStats();
            
            // æ˜¾ç¤ºæ“ä½œåé¦ˆ
            showNotification(`å·²åˆ é™¤æ­Œæ›²: ${songName}`);
        }
        
        // æ¸…ç©ºåˆ—è¡¨
        function clearList(mode) {
            // è®°å½•æ¸…ç©ºå‰çš„æ•°é‡ï¼Œç”¨äºæ˜¾ç¤ºåé¦ˆ
            const data = mode === 'b30' ? b30Data : r10Data;
            const countBefore = data.length;
            
            if (mode === 'b30') {
                b30Data = [];
            } else if (mode === 'r10') {
                r10Data = [];
            }
            
            updateListDisplay(mode);
            updateStats();
            
            // æ˜¾ç¤ºæ“ä½œåé¦ˆ
            if (countBefore > 0) {
                showNotification(`å·²æ¸…ç©º ${countBefore} é¦–æ­Œæ›²çš„æˆç»©`);
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const b30SummaryDiv = document.getElementById('b30-summary');
            
            if (b30Data.length === 0 && r10Data.length === 0) {
                b30SummaryDiv.style.display = 'none';
                return;
            }
            
            b30SummaryDiv.style.display = 'block';
            
            // è®¡ç®—ç©å®¶PTTï¼š(B30å„å•æ›²pttæ€»å’Œ+R10å„å•æ›²pttæ€»å’Œ)/40
            let totalPTT = 0;
            if (b30Data.length > 0) {
                totalPTT += b30Data.reduce((sum, item) => sum + item.single_ptt, 0);
            }
            if (r10Data.length > 0) {
                totalPTT += r10Data.reduce((sum, item) => sum + item.single_ptt, 0);
            }
            
            const totalCount = Math.max(b30Data.length + r10Data.length, 1);
            const playerPTT = totalPTT / Math.max(totalCount, 1);
            
            // è®¡ç®—R10å¹³å‡å€¼
            let r10Average = 0;
            if (r10Data.length > 0) {
                r10Average = r10Data.reduce((sum, item) => sum + item.single_ptt, 0) / r10Data.length;
            } else {
                // å¦‚æœæ²¡æœ‰R10æ•°æ®ï¼Œä½¿ç”¨B10å¹³å‡å€¼ä½œä¸ºR10å¹³å‡å€¼
                const sortedB30 = [...b30Data].sort((a, b) => b.single_ptt - a.single_ptt);
                const top10 = sortedB30.slice(0, Math.min(10, sortedB30.length));
                if (top10.length > 0) {
                    r10Average = top10.reduce((sum, item) => sum + item.single_ptt, 0) / top10.length;
                }
            }
            
            // è®¡ç®—åœ°æ¿PTTï¼ˆå–B30ä¸­å•æ›²PTTæœ€ä½çš„é‚£é¦–æ­Œçš„PTTï¼‰
            let floorPTT = 0;
            if (b30Data.length > 0) {
                const sortedByPTT = [...b30Data].sort((a, b) => a.single_ptt - b.single_ptt);
                floorPTT = sortedByPTT[0].single_ptt;
            }
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('player-ptt').textContent = playerPTT.toFixed(2);
            document.getElementById('r10-average-ptt').textContent = r10Average.toFixed(2);
            document.getElementById('floor-ptt').textContent = floorPTT.toFixed(2);
        }
        
        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData(mode) {
            const data = mode === 'b30' ? b30Data : r10Data;
            
            if (data.length === 0) {
                alert(`æ²¡æœ‰å¯å¯¼å‡ºçš„${mode.toUpperCase()}æ•°æ®`);
                return;
            }
            
            // å‡†å¤‡å¯¼å‡ºæ•°æ®
            const exportData = {
                version: '1.0',
                type: mode.toUpperCase(),
                exportDate: new Date().toISOString(),
                data: data
            };
            
            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `arcaea-${mode}-${new Date().toISOString().slice(0, 10)}.json`;
            
            // è§¦å‘ä¸‹è½½
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // é‡Šæ”¾URLå¯¹è±¡
            URL.revokeObjectURL(url);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            alert(`æˆåŠŸå¯¼å‡º ${data.length} æ¡${mode.toUpperCase()}æ•°æ®`);
        }
        
        // å¯¼å…¥æ•°æ®
        function importData(mode, event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.json')) {
                alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶');
                event.target.value = '';
                return;
            }
            
            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // è§£æJSONæ•°æ®
                    const importedData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!importedData.data || !Array.isArray(importedData.data)) {
                        alert('æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„æ•°æ®æ–‡ä»¶');
                        return;
                    }
                    
                    // ç¡®è®¤å¯¼å…¥
                    const itemCount = importedData.data.length;
                    if (itemCount === 0) {
                        alert('æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®');
                        return;
                    }
                    
                    const maxCount = mode === 'b30' ? 30 : 10;
                    const confirmImport = confirm(
                        `å³å°†å¯¼å…¥ ${itemCount} æ¡${mode.toUpperCase()}æ•°æ®ã€‚` +
                        (itemCount > maxCount ? `\næ³¨æ„ï¼šæœ€å¤šåªèƒ½å¯¼å…¥${maxCount}æ¡æ•°æ®ã€‚` : '') +
                        (mode === 'b30' && b30Data.length > 0 ? '\næ³¨æ„ï¼šå¯¼å…¥ä¼šæ¸…ç©ºå½“å‰å·²æœ‰çš„B30æ•°æ®ã€‚' : '') +
                        (mode === 'r10' && r10Data.length > 0 ? '\næ³¨æ„ï¼šå¯¼å…¥ä¼šæ¸…ç©ºå½“å‰å·²æœ‰çš„R10æ•°æ®ã€‚' : '') +
                        '\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
                    );
                    
                    if (!confirmImport) {
                        event.target.value = '';
                        return;
                    }
                    
                    // éªŒè¯æ¯æ¡æ•°æ®çš„å®Œæ•´æ€§
                    const validData = [];
                    for (let i = 0; i < Math.min(itemCount, maxCount); i++) {
                        const item = importedData.data[i];
                        if (item.song_id && item.difficulty && item.constant && item.score) {
                            // ç¡®ä¿æœ‰single_ptt
                            if (!item.single_ptt) {
                                item.single_ptt = calculateSinglePTT(item.score, item.constant);
                            }
                            validData.push(item);
                        }
                    }
                    
                    if (validData.length === 0) {
                        alert('æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®');
                        return;
                    }
                    
                    // å¯¼å…¥æ•°æ®
                    if (mode === 'b30') {
                        b30Data = validData;
                    } else if (mode === 'r10') {
                        r10Data = validData;
                    }
                    
                    updateListDisplay(mode);
                    updateStats();
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    event.target.value = '';
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showNotification(`æˆåŠŸå¯¼å…¥ ${validData.length} æ¡${mode.toUpperCase()}æ•°æ®`);
                    
                } catch (error) {
                    console.error('å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:', error);
                    alert('å¯¼å…¥æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                    event.target.value = '';
                }
            };
            
            reader.onerror = function() {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // çˆ¬è™«æ•°æ®å¯¼å…¥åŠŸèƒ½
        function importCrawlerData() {
            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡†ç”¨äºé€‰æ‹©çˆ¬è™«å¯¼å…¥æ–¹å¼
            const modal = document.createElement('div');
            modal.className = 'confirm-dialog';
            modal.innerHTML = `
                <div class="confirm-content crawler-modal">
                    <h3>å¯¼å…¥çˆ¬è™«æ•°æ®</h3>
                    <p>è¯·é€‰æ‹©ä¸€ç§æ–¹å¼å¯¼å…¥æ‚¨çš„B30å’ŒR10æ•°æ®ï¼š</p>
                    <div class="crawler-method-tabs">
                        <button class="crawler-tab active" onclick="switchCrawlerTab('manual')">æ‰‹åŠ¨ç²˜è´´æ•°æ®</button>
                        <button class="crawler-tab" onclick="switchCrawlerTab('auto')">è‡ªåŠ¨è·å–æ•°æ®</button>
                        <button class="crawler-tab" onclick="switchCrawlerTab('tutorial')">çˆ¬è™«æ•™ç¨‹</button>
                    </div>
                    
                    <div id="manual-method" class="crawler-method active">
                        <h4>æ‰‹åŠ¨ç²˜è´´çˆ¬è™«æ•°æ® - è¯¦ç»†æ­¥éª¤</h4>
                        <div class="manual-steps">
                            <div class="manual-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>è·å–çˆ¬è™«æ•°æ®</h5>
                                    <p>ä½¿ç”¨æ‚¨å·²æœ‰çš„çˆ¬è™«å·¥å…·æˆ–ä»å…¶ä»–æ¥æºè·å–Arcaea B30å’ŒR10æ•°æ®</p>
                                    <div class="data-format-examples">
                                        <h6>æ”¯æŒçš„æ•°æ®æ ¼å¼ç¤ºä¾‹ï¼š</h6>
                                        <div class="format-example">
                                            <strong>æ ¼å¼1ï¼š</strong>
                                            <code>B30æ•°æ®ï¼š<br>æ­Œæ›²å1 - éš¾åº¦ - åˆ†æ•°<br>æ­Œæ›²å2 - éš¾åº¦ - åˆ†æ•°<br>...</code>
                                        </div>
                                        <div class="format-example">
                                            <strong>æ ¼å¼2ï¼š</strong>
                                            <code>R10æ•°æ®ï¼š<br>1. æ­Œæ›²å1 [FTR] 9750000<br>2. æ­Œæ›²å2 [BYD] 9950000<br>...</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="manual-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>å¤åˆ¶æ•°æ®</h5>
                                    <p>é€‰ä¸­æ‰€æœ‰çˆ¬è™«æ•°æ®ï¼ŒæŒ‰ Ctrl+C (Windows) æˆ– Cmd+C (Mac) å¤åˆ¶åˆ°å‰ªè´´æ¿</p>
                                </div>
                            </div>
                            <div class="manual-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>ç²˜è´´æ•°æ®</h5>
                                    <p>ç‚¹å‡»ä¸‹æ–¹æ–‡æœ¬æ¡†ï¼ŒæŒ‰ Ctrl+V (Windows) æˆ– Cmd+V (Mac) ç²˜è´´æ•°æ®</p>
                                    <textarea id="crawler-data-input" placeholder="è¯·åœ¨æ­¤ç²˜è´´çˆ¬è™«è·å–çš„æ•°æ®..."></textarea>
                                </div>
                            </div>
                            <div class="manual-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>å¯¼å…¥æ•°æ®</h5>
                                    <p>ç‚¹å‡»"å¯¼å…¥æ•°æ®"æŒ‰é’®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è§£æå¹¶å¡«å……åˆ°B30å’ŒR10åˆ—è¡¨ä¸­</p>
                                    <div class="confirm-buttons">
                                        <button class="confirm-btn confirm-yes" onclick="processCrawlerData()">å¯¼å…¥æ•°æ®</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="auto-method" class="crawler-method">
                        <p>æ­¤åŠŸèƒ½éœ€è¦å®‰è£…ä¸“ç”¨å·¥å…·æ‰èƒ½è‡ªåŠ¨è·å–Arcaea Onlineæ•°æ®ã€‚</p>
                        <p>è¯·é€‰æ‹©é€‚åˆæ‚¨çš„è‡ªåŠ¨åŒ–æ–¹æ¡ˆï¼š</p>
                        <div class="crawler-tools">
                            <div class="tool-card">
                                <h4>Chromeæ‰©å±•çˆ¬è™«</h4>
                                <p>å®‰è£…æˆ‘ä»¬çš„Chromeæ‰©å±•ç¨‹åºï¼Œä¸€é”®å¯¼å…¥æ‚¨çš„B30å’ŒR10æ•°æ®ã€‚</p>
                                <div class="extension-steps">
                                    <h5>ä½¿ç”¨æ­¥éª¤ï¼š</h5>
                                    <ol>
                                        <li>ç‚¹å‡»ä¸‹æ–¹"è·å–æ‰©å±•"æŒ‰é’®</li>
                                        <li>åœ¨Chromeç½‘ä¸Šåº”ç”¨åº—å®‰è£…æ‰©å±•</li>
                                        <li>æ‰“å¼€Arcaea Onlineå¹¶ç™»å½•</li>
                                        <li>ç‚¹å‡»æ‰©å±•å›¾æ ‡ï¼Œé€‰æ‹©"å¯¼å‡ºB30/R10"</li>
                                        <li>æ•°æ®å°†è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿</li>
                                        <li>è¿”å›PTTè®¡ç®—å™¨ï¼Œä½¿ç”¨"æ‰‹åŠ¨ç²˜è´´"åŠŸèƒ½å¯¼å…¥</li>
                                    </ol>
                                </div>
                                <button class="tool-btn" onclick="openExtensionPage()">è·å–æ‰©å±•</button>
                            </div>
                            <div class="tool-card">
                                <h4>ç‹¬ç«‹çˆ¬è™«ç¨‹åº</h4>
                                <p>ä¸‹è½½ç‹¬ç«‹çš„çˆ¬è™«ç¨‹åºï¼Œè‡ªåŠ¨è·å–æ‚¨çš„Arcaeaæ•°æ®å¹¶ç”Ÿæˆå¯¼å…¥æ–‡ä»¶ã€‚</p>
                                <div class="crawler-usage">
                                    <h5>ä¸‹è½½åçš„ä½¿ç”¨æ­¥éª¤ï¼š</h5>
                                    <ol>
                                        <li><strong>è§£å‹ç¨‹åºï¼š</strong>å³é”®ç‚¹å‡»ä¸‹è½½çš„å‹ç¼©åŒ…ï¼Œé€‰æ‹©"è§£å‹åˆ°å½“å‰æ–‡ä»¶å¤¹"</li>
                                        <li><strong>å‡†å¤‡è´¦å·ä¿¡æ¯ï¼š</strong>ç¡®ä¿æ‚¨çŸ¥é“Arcaea Onlineçš„ç”¨æˆ·åå’Œå¯†ç </li>
                                        <li><strong>è¿è¡Œç¨‹åºï¼š</strong>åŒå‡»è§£å‹åçš„çˆ¬è™«ç¨‹åºæ–‡ä»¶ï¼ˆWindows: crawler.exeï¼ŒMac: crawler.appï¼‰</li>
                                        <li><strong>è¾“å…¥å‡­è¯ï¼š</strong>åœ¨ç¨‹åºç•Œé¢è¾“å…¥æ‚¨çš„Arcaea Onlineè´¦å·å’Œå¯†ç </li>
                                        <li><strong>å¼€å§‹çˆ¬å–ï¼š</strong>ç‚¹å‡»"å¼€å§‹çˆ¬å–"æŒ‰é’®ï¼Œç¨‹åºå°†è‡ªåŠ¨è·å–æ‚¨çš„B30å’ŒR10æ•°æ®</li>
                                        <li><strong>è·å–ç»“æœï¼š</strong>çˆ¬å–å®Œæˆåï¼Œç¨‹åºå°†æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è‡ªåŠ¨å°†æ•°æ®å¤åˆ¶åˆ°å‰ªè´´æ¿</li>
                                        <li><strong>å¯¼å…¥æ•°æ®ï¼š</strong>è¿”å›PTTè®¡ç®—å™¨ï¼Œä½¿ç”¨"æ‰‹åŠ¨ç²˜è´´"åŠŸèƒ½ï¼ŒæŒ‰Ctrl+Vç²˜è´´æ•°æ®</li>
                                    </ol>
                                    <div class="tips">
                                        <h6>ğŸ’¡ å°è´´å£«ï¼š</h6>
                                        <ul>
                                            <li>çˆ¬è™«ç¨‹åºä¼šå°†æ•°æ®è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ‚¨æ— éœ€æ‰‹åŠ¨è°ƒæ•´</li>
                                            <li>ç¨‹åºæ”¯æŒè‡ªåŠ¨è¯†åˆ«B30å’ŒR10åŒºåŸŸ</li>
                                            <li>å¦‚æœçˆ¬å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œè´¦å·ä¿¡æ¯</li>
                                            <li>ç¨‹åºä¸ä¼šä¿å­˜æ‚¨çš„å¯†ç ï¼Œä½¿ç”¨åå®‰å…¨é€€å‡º</li>
                                        </ul>
                                    </div>
                                </div>
                                <button class="tool-btn" onclick="downloadCrawler()">ä¸‹è½½çˆ¬è™«</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tutorial-method" class="crawler-method">
                        <h4>å¦‚ä½•ä½¿ç”¨çˆ¬è™«è·å–æ•°æ®</h4>
                        <div class="tutorial-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>å®‰è£…çˆ¬è™«å·¥å…·</h5>
                                    <p>ä»GitHubä¸‹è½½é€‚ç”¨äºæ‚¨çš„æ“ä½œç³»ç»Ÿçš„çˆ¬è™«ç¨‹åº</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>è·å–æˆæƒä»¤ç‰Œ</h5>
                                    <p>åœ¨Arcaea Onlineè®¾ç½®ä¸­è·å–æ‚¨çš„APIè®¿é—®ä»¤ç‰Œ</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>è¿è¡Œçˆ¬è™«</h5>
                                    <p>æ‰§è¡Œçˆ¬è™«ç¨‹åºï¼Œå®ƒå°†è‡ªåŠ¨è·å–æ‚¨çš„B30å’ŒR10æ•°æ®</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>å¯¼å…¥æ•°æ®</h5>
                                    <p>å°†çˆ¬è™«ç”Ÿæˆçš„æ•°æ®å¤åˆ¶åˆ°ä¸Šé¢çš„"æ‰‹åŠ¨ç²˜è´´æ•°æ®"é€‰é¡¹å¡ä¸­</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm-no" onclick="closeCrawlerModal()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // å¤„ç†çˆ¬è™«æ•°æ®
        function processCrawlerData() {
            const input = document.getElementById('crawler-data-input').value;
            if (!input.trim()) {
                alert('è¯·è¾“å…¥çˆ¬è™«æ•°æ®');
                return;
            }
            
            try {
                // å°è¯•è§£æä¸åŒæ ¼å¼çš„çˆ¬è™«æ•°æ®
                let b30Items = [];
                let r10Items = [];
                
                // å°è¯•è§£æçˆ¬è™«è¾“å‡ºæ ¼å¼
                // æ ¼å¼1: "B30æ•°æ®ï¼šæ­Œæ›²å - éš¾åº¦ - åˆ†æ•°"
                // æ ¼å¼2: "R10æ•°æ®ï¼šæ­Œæ›²å - éš¾åº¦ - åˆ†æ•°"
                // æ ¼å¼3: "æ’å. æ­Œæ›²å [éš¾åº¦] åˆ†æ•°"
                
                const lines = input.split('\n').filter(line => line.trim());
                let currentMode = null; // 'b30' æˆ– 'r10'
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    
                    // æ£€æµ‹B30/R10æ•°æ®åŒºåŸŸ
                    if (trimmedLine.includes('B30') || trimmedLine.includes('b30')) {
                        currentMode = 'b30';
                        continue;
                    }
                    if (trimmedLine.includes('R10') || trimmedLine.includes('r10')) {
                        currentMode = 'r10';
                        continue;
                    }
                    
                    // å°è¯•åŒ¹é…æ•°æ®è¡Œ
                    // æ ¼å¼1: "æ­Œæ›²å - éš¾åº¦ - åˆ†æ•°"
                    let match = trimmedLine.match(/^(.+?)\s*-\s*([A-Z]+)\s*-\s*(\d+)$/);
                    if (match) {
                        const [, songName, difficulty, scoreStr] = match;
                        const score = parseInt(scoreStr);
                        if (currentMode === 'b30') {
                            b30Items.push({ songName, difficulty, score });
                        } else if (currentMode === 'r10') {
                            r10Items.push({ songName, difficulty, score });
                        }
                        continue;
                    }
                    
                    // æ ¼å¼2: "æ’å. æ­Œæ›²å [éš¾åº¦] åˆ†æ•°"
                    match = trimmedLine.match(/^\d+\.\s+(.+?)\s*\[([A-Z]+)\]\s+(\d+)$/);
                    if (match) {
                        const [, songName, difficulty, scoreStr] = match;
                        const score = parseInt(scoreStr);
                        if (currentMode === 'b30') {
                            b30Items.push({ songName, difficulty, score });
                        } else if (currentMode === 'r10') {
                            r10Items.push({ songName, difficulty, score });
                        }
                        continue;
                    }
                    
                    // æ ¼å¼3: "æ­Œæ›²å éš¾åº¦ åˆ†æ•°"
                    match = trimmedLine.match(/^(.+?)\s+([A-Z]+)\s+(\d+)$/);
                    if (match) {
                        const [, songName, difficulty, scoreStr] = match;
                        const score = parseInt(scoreStr);
                        if (currentMode === 'b30') {
                            b30Items.push({ songName, difficulty, score });
                        } else if (currentMode === 'r10') {
                            r10Items.push({ songName, difficulty, score });
                        }
                        continue;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æ˜ç¡®çš„B30/R10åŒºåŸŸï¼Œå°è¯•æ™ºèƒ½åˆ†å‰²
                if (b30Items.length === 0 && r10Items.length === 0 && lines.length > 0) {
                    // å‡è®¾å‰30æ¡æ˜¯B30ï¼Œå10æ¡æ˜¯R10
                    const allItems = [];
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue;
                        
                        // å°è¯•åŒ¹é…ä»»æ„æ ¼å¼çš„æ•°æ®è¡Œ
                        let match = trimmedLine.match(/^(.+?)\s*-\s*([A-Z]+)\s*-\s*(\d+)$/);
                        if (match) {
                            const [, songName, difficulty, scoreStr] = match;
                            allItems.push({ songName, difficulty, score: parseInt(scoreStr) });
                            continue;
                        }
                        
                        match = trimmedLine.match(/^\d+\.\s+(.+?)\s*\[([A-Z]+)\]\s+(\d+)$/);
                        if (match) {
                            const [, songName, difficulty, scoreStr] = match;
                            allItems.push({ songName, difficulty, score: parseInt(scoreStr) });
                            continue;
                        }
                        
                        match = trimmedLine.match(/^(.+?)\s+([A-Z]+)\s+(\d+)$/);
                        if (match) {
                            const [, songName, difficulty, scoreStr] = match;
                            allItems.push({ songName, difficulty, score: parseInt(scoreStr) });
                        }
                    }
                    
                    // åˆ†å‰²ä¸ºB30å’ŒR10
                    if (allItems.length >= 10) {
                        b30Items = allItems.slice(0, Math.min(30, allItems.length - 10));
                        r10Items = allItems.slice(Math.min(30, allItems.length - 10), Math.min(allItems.length, 40));
                    } else if (allItems.length > 0) {
                        // å¦‚æœæ•°æ®ä¸è¶³ï¼Œå…¨éƒ¨æ”¾å…¥B30
                        b30Items = allItems.slice(0, 30);
                    }
                }
                
                if (b30Items.length === 0 && r10Items.length === 0) {
                    alert('æœªèƒ½è¯†åˆ«æœ‰æ•ˆçš„æ•°æ®æ ¼å¼ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°æ®æ ¼å¼');
                    return;
                }
                
                // è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼å¹¶æ£€æŸ¥æ­Œæ›²æ•°æ®åº“
                const processedB30 = [];
                const processedR10 = [];
                
                for (const item of b30Items) {
                    const processed = processCrawlerItem(item);
                    if (processed) {
                        processedB30.push(processed);
                    }
                }
                
                for (const item of r10Items) {
                    const processed = processCrawlerItem(item);
                    if (processed) {
                        processedR10.push(processed);
                    }
                }
                
                // å¯¼å…¥æ•°æ®
                let successCount = 0;
                
                if (processedB30.length > 0) {
                    b30Data = processedB30.slice(0, 30); // é™åˆ¶ä¸º30é¦–
                    updateListDisplay('b30');
                    successCount += processedB30.length;
                }
                
                if (processedR10.length > 0) {
                    r10Data = processedR10.slice(0, 10); // é™åˆ¶ä¸º10é¦–
                    updateListDisplay('r10');
                    successCount += processedR10.length;
                }
                
                updateStats();
                closeCrawlerModal();
                
                showNotification(`æˆåŠŸå¯¼å…¥ ${successCount} æ¡æ­Œæ›²æ•°æ® (B30: ${processedB30.length}, R10: ${processedR10.length})`);
                
            } catch (error) {
                console.error('å¤„ç†çˆ¬è™«æ•°æ®æ—¶å‡ºé”™:', error);
                alert('å¤„ç†çˆ¬è™«æ•°æ®æ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®');
            }
        }
        
        // å¤„ç†å•ä¸ªçˆ¬è™«æ•°æ®é¡¹
        function processCrawlerItem(item) {
            const { songName, difficulty, score } = item;
            
            // æŸ¥æ‰¾æ­Œæ›²æ•°æ®åº“ä¸­æœ€æ¥è¿‘çš„åŒ¹é…
            let bestMatch = null;
            let bestScore = 0;
            
            for (const dbSongName in songConstants) {
                // å®Œå…¨åŒ¹é…
                if (dbSongName === songName) {
                    bestMatch = dbSongName;
                    break;
                }
                
                // æ¨¡ç³ŠåŒ¹é…
                const similarity = calculateSimilarity(songName.toLowerCase(), dbSongName.toLowerCase());
                if (similarity > bestScore && similarity > 0.7) { // ç›¸ä¼¼åº¦é˜ˆå€¼
                    bestScore = similarity;
                    bestMatch = dbSongName;
                }
            }
            
            if (!bestMatch) {
                console.warn(`æœªæ‰¾åˆ°æ­Œæ›²: ${songName}`);
                return null;
            }
            
            // è·å–éš¾åº¦
            const diffLower = difficulty.toLowerCase();
            let diffKey = null;
            
            // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„éš¾åº¦è¡¨ç¤º
            if (diffLower === 'pst' || diffLower === 'past') {
                diffKey = 'pst';
            } else if (diffLower === 'prs' || diffLower === 'present') {
                diffKey = 'prs';
            } else if (diffLower === 'ftr' || diffLower === 'future') {
                diffKey = 'ftr';
            } else if (diffLower === 'byd' || diffLower === 'beyond') {
                diffKey = 'byd';
            } else if (diffLower === 'etr' || diffLower === 'eternal') {
                diffKey = 'etr';
            }
            
            if (!diffKey) {
                console.warn(`æ— æ•ˆçš„éš¾åº¦: ${difficulty}`);
                return null;
            }
            
            const songConstant = songConstants[bestMatch];
            if (!songConstant || songConstant[diffKey] === null || songConstant[diffKey] === undefined) {
                console.warn(`æ­Œæ›² ${bestMatch} æ²¡æœ‰éš¾åº¦ ${difficulty}`);
                return null;
            }
            
            const constant = songConstant[diffKey];
            
            return {
                song_id: bestMatch,
                difficulty: diffKey,
                constant: constant,
                score: score,
                single_ptt: calculateSinglePTT(score, constant)
            };
        }
        
        // è®¡ç®—å­—ç¬¦ä¸²ç›¸ä¼¼åº¦ï¼ˆç®€å•çš„Levenshteinè·ç¦»ï¼‰
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            
            const matrix = [];
            for (let i = 0; i <= str1.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str2.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str1.length; i++) {
                for (let j = 1; j <= str2.length; j++) {
                    if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            const distance = matrix[str1.length][str2.length];
            const maxLen = Math.max(str1.length, str2.length);
            return (maxLen - distance) / maxLen;
        }
        
        // åˆ‡æ¢çˆ¬è™«é€‰é¡¹å¡
        function switchCrawlerTab(tabName) {
            // åˆ‡æ¢é€‰é¡¹å¡æ ·å¼
            document.querySelectorAll('.crawler-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.crawler-method').forEach(method => method.classList.remove('active'));
            document.getElementById(`${tabName}-method`).classList.add('active');
        }
        
        // æ‰“å¼€æ‰©å±•ç¨‹åºé¡µé¢
        function openExtensionPage() {
            // åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰©å±•ä¸‹è½½ä¿¡æ¯çš„æ¨¡æ€æ¡†
            const extensionModal = document.createElement('div');
            extensionModal.className = 'confirm-dialog extension-dialog';
            extensionModal.innerHTML = `
                <div class="confirm-content">
                    <h3>æµè§ˆå™¨æ‰©å±•ç¨‹åº</h3>
                    <p>æˆ‘ä»¬æ­£åœ¨å¼€å‘Chromeå’ŒFirefoxæ‰©å±•ç¨‹åºï¼Œå¯ä»¥è®©æ‚¨ä¸€é”®å¯¼å…¥Arcaeaæ•°æ®ã€‚</p>
                    <p>ç›®å‰æ‰©å±•ç¨‹åºä»åœ¨å®¡æ ¸ä¸­ï¼Œè¯·ç¨åå…³æ³¨æˆ‘ä»¬çš„æ›´æ–°ã€‚</p>
                    <div class="extension-info">
                        <div class="info-item">
                            <div class="info-icon">ğŸš€</div>
                            <div class="info-text">
                                <h4>å³å°†æ¨å‡º</h4>
                                <p>Chromeå’ŒFirefoxæ‰©å±•ç¨‹åº</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">ğŸ”§</div>
                            <div class="info-text">
                                <h4>åŠŸèƒ½ç‰¹æ€§</h4>
                                <p>è‡ªåŠ¨ç™»å½•ã€æ•°æ®è·å–ã€ä¸€é”®å¯¼å…¥</p>
                            </div>
                        </div>
                    </div>
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm-yes" onclick="closeExtensionModal()">äº†è§£</button>
                        <button class="confirm-btn confirm-no" onclick="closeExtensionModal()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.appendChild(extensionModal);
        }
        
        // å…³é—­æ‰©å±•ç¨‹åºæ¨¡æ€æ¡†
        function closeExtensionModal() {
            const modal = document.querySelector('.extension-dialog');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // ä¸‹è½½çˆ¬è™«ç¨‹åº
        function downloadCrawler() {
            // åˆ›å»ºä¸€ä¸ªåŒ…å«çˆ¬è™«ä¸‹è½½ä¿¡æ¯çš„æ¨¡æ€æ¡†
            const crawlerModal = document.createElement('div');
            crawlerModal.className = 'confirm-dialog';
            crawlerModal.innerHTML = `
                <div class="confirm-content">
                    <h3>çˆ¬è™«ç¨‹åºä¸‹è½½</h3>
                    <p>è¯·é€‰æ‹©é€‚ç”¨äºæ‚¨æ“ä½œç³»ç»Ÿçš„çˆ¬è™«ç¨‹åºï¼š</p>
                    <div class="crawler-downloads">
                        <div class="download-card">
                            <div class="os-icon">ğŸªŸ</div>
                            <h4>Windows</h4>
                            <p>é€‚ç”¨äºWindows 10/11</p>
                            <button class="download-btn" onclick="downloadCrawlerFile('windows')">ä¸‹è½½Windowsç‰ˆ</button>
                        </div>
                        <div class="download-card">
                            <div class="os-icon">ğŸ</div>
                            <h4>macOS</h4>
                            <p>é€‚ç”¨äºmacOS 10.15+</p>
                            <button class="download-btn" onclick="downloadCrawlerFile('macos')">ä¸‹è½½macOSç‰ˆ</button>
                        </div>
                        <div class="download-card">
                            <div class="os-icon">ğŸ§</div>
                            <h4>Linux</h4>
                            <p>é€‚ç”¨äºå¤§å¤šæ•°Linuxå‘è¡Œç‰ˆ</p>
                            <button class="download-btn" onclick="downloadCrawlerFile('linux')">ä¸‹è½½Linuxç‰ˆ</button>
                        </div>
                    </div>
                    <div class="crawler-notes">
                        <h4>ä½¿ç”¨è¯´æ˜</h4>
                        <ol>
                            <li>ä¸‹è½½å¹¶è§£å‹çˆ¬è™«ç¨‹åº</li>
                            <li>è¿è¡Œç¨‹åºå¹¶è¾“å…¥æ‚¨çš„Arcaea Onlineè´¦å·ä¿¡æ¯</li>
                            <li>ç¨‹åºå°†è‡ªåŠ¨è·å–æ‚¨çš„B30å’ŒR10æ•°æ®</li>
                            <li>ç”Ÿæˆçš„æ•°æ®å°†è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç›´æ¥ç²˜è´´åˆ°PTTè®¡ç®—å™¨ä¸­</li>
                        </ol>
                        <p class="warning">æ³¨æ„ï¼šçˆ¬è™«ç¨‹åºä»…ç”¨äºä¸ªäººæ•°æ®æ•´ç†ï¼Œè¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”æˆ–è¿åArcaeaæœåŠ¡æ¡æ¬¾ã€‚</p>
                    </div>
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm-no" onclick="closeCrawlerModal()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.appendChild(crawlerModal);
        }
        
        // ä¸‹è½½çˆ¬è™«æ–‡ä»¶
        function downloadCrawlerFile(os) {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const downloadLinks = {
                windows: './crawler/arcaea_crawler.py',
                macos: './crawler/arcaea_crawler.py',
                linux: './crawler/arcaea_crawler.py'
            };
            
            const launcherFiles = {
                windows: './crawler/run_windows.bat',
                macos: './crawler/run_unix.sh',
                linux: './crawler/run_unix.sh'
            };
            
            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†ï¼Œæ˜¾ç¤ºä¸‹è½½è¯´æ˜
            const downloadModal = document.createElement('div');
            downloadModal.className = 'confirm-dialog download-dialog';
            
            const osNames = {
                windows: 'Windows',
                macos: 'macOS',
                linux: 'Linux'
            };
            
            const instructions = {
                windows: {
                    title: 'Windowsç”¨æˆ·ä½¿ç”¨è¯´æ˜',
                    steps: [
                        'ç‚¹å‡»ä¸‹æ–¹"ä¸‹è½½çˆ¬è™«ç¨‹åº"æŒ‰é’®ï¼Œä¸‹è½½Pythonè„šæœ¬',
                        'åŒå‡»è¿è¡Œ"run_windows.bat"æ–‡ä»¶ï¼ˆæ¨èï¼‰',
                        'æˆ–è€…åœ¨å‘½ä»¤æç¤ºç¬¦ä¸­è¿è¡Œ"python arcaea_crawler.py"',
                        'ç¨‹åºå°†è‡ªåŠ¨è·å–æ•°æ®å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿',
                        'è¿”å›PTTè®¡ç®—å™¨ï¼Œä½¿ç”¨"æ‰‹åŠ¨ç²˜è´´"åŠŸèƒ½å¯¼å…¥'
                    ]
                },
                macos: {
                    title: 'macOSç”¨æˆ·ä½¿ç”¨è¯´æ˜',
                    steps: [
                        'ç‚¹å‡»ä¸‹æ–¹"ä¸‹è½½çˆ¬è™«ç¨‹åº"æŒ‰é’®ï¼Œä¸‹è½½Pythonè„šæœ¬',
                        'æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥ä¸‹è½½ç›®å½•',
                        'è¿è¡Œ"chmod +x run_unix.sh"èµ‹äºˆæ‰§è¡Œæƒé™',
                        'è¿è¡Œ"./run_unix.sh"å¯åŠ¨çˆ¬è™«',
                        'æˆ–è€…ç›´æ¥è¿è¡Œ"python3 arcaea_crawler.py"',
                        'ç¨‹åºå°†è‡ªåŠ¨è·å–æ•°æ®å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿',
                        'è¿”å›PTTè®¡ç®—å™¨ï¼Œä½¿ç”¨"æ‰‹åŠ¨ç²˜è´´"åŠŸèƒ½å¯¼å…¥'
                    ]
                },
                linux: {
                    title: 'Linuxç”¨æˆ·ä½¿ç”¨è¯´æ˜',
                    steps: [
                        'ç‚¹å‡»ä¸‹æ–¹"ä¸‹è½½çˆ¬è™«ç¨‹åº"æŒ‰é’®ï¼Œä¸‹è½½Pythonè„šæœ¬',
                        'æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥ä¸‹è½½ç›®å½•',
                        'è¿è¡Œ"chmod +x run_unix.sh"èµ‹äºˆæ‰§è¡Œæƒé™',
                        'è¿è¡Œ"./run_unix.sh"å¯åŠ¨çˆ¬è™«',
                        'æˆ–è€…ç›´æ¥è¿è¡Œ"python3 arcaea_crawler.py"',
                        'ç¨‹åºå°†è‡ªåŠ¨è·å–æ•°æ®å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿',
                        'è¿”å›PTTè®¡ç®—å™¨ï¼Œä½¿ç”¨"æ‰‹åŠ¨ç²˜è´´"åŠŸèƒ½å¯¼å…¥'
                    ]
                }
            };
            
            const currentOs = instructions[os];
            
            downloadModal.innerHTML = `
                <div class="confirm-content">
                    <h3>çˆ¬è™«ç¨‹åºä¸‹è½½ - ${osNames[os]}ç‰ˆ</h3>
                    
                    <div class="download-file-info">
                        <h4>æ–‡ä»¶ä¿¡æ¯</h4>
                        <p><strong>ä¸»ç¨‹åºï¼š</strong>arcaea_crawler.py (Pythonè„šæœ¬)</p>
                        <p><strong>å¯åŠ¨è„šæœ¬ï¼š</strong>${os === 'windows' ? 'run_windows.bat' : 'run_unix.sh'}</p>
                        <p><strong>è¯´æ˜æ–‡æ¡£ï¼š</strong>README.md</p>
                    </div>
                    
                    <div class="download-steps">
                        <h4>${currentOs.title}</h4>
                        <ol>
                            ${currentOs.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                        
                        <h4>ä¾èµ–è¦æ±‚</h4>
                        <ul>
                            <li>Python 3.6æˆ–æ›´é«˜ç‰ˆæœ¬</li>
                            <li>ä¾èµ–åº“ï¼šrequests, beautifulsoup4, pyperclip</li>
                            <li>å¯åŠ¨è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–åº“</li>
                        </ul>
                        
                        <div class="download-buttons">
                            <button class="download-file-btn" onclick="downloadFile('${downloadLinks[os]}')">
                                ä¸‹è½½çˆ¬è™«ç¨‹åº
                            </button>
                            <button class="download-file-btn" onclick="downloadFile('${launcherFiles[os]}')">
                                ä¸‹è½½å¯åŠ¨è„šæœ¬
                            </button>
                            <button class="download-file-btn" onclick="downloadFile('./crawler/README.md')">
                                ä¸‹è½½è¯´æ˜æ–‡æ¡£
                            </button>
                        </div>
                        
                        <div class="security-note">
                            <h6>ğŸ”’ å®‰å…¨æç¤º</h6>
                            <p>è¿™æ˜¯å¼€æºçš„Pythonè„šæœ¬ï¼Œæ‚¨å¯ä»¥åœ¨è¿è¡Œå‰æŸ¥çœ‹æºä»£ç ä»¥ç¡®ä¿å®‰å…¨æ€§ã€‚</p>
                            <p>ç¨‹åºä»…ç”¨äºè·å–æ‚¨è‡ªå·±çš„æ¸¸æˆæ•°æ®ï¼Œä¸ä¼šä¿å­˜æˆ–åˆ†äº«æ‚¨çš„å¯†ç ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm-yes" onclick="copyDownloadLink('${os}')">å¤åˆ¶ä¸‹è½½é“¾æ¥</button>
                        <button class="confirm-btn confirm-no" onclick="closeDownloadModal()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.appendChild(downloadModal);
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(fileUrl) {
            // åˆ›å»ºä¸€ä¸ªé€šçŸ¥ï¼Œå‘ŠçŸ¥ç”¨æˆ·ä¸‹è½½å·²å¼€å§‹
            const fileName = fileUrl.split('/').pop();
            showNotification(`æ­£åœ¨ä¸‹è½½ ${fileName}...`);
            
            // åˆ›å»ºä¸€ä¸ªä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // å»¶è¿Ÿæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                showNotification(`${fileName} ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·æŸ¥çœ‹æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹`);
            }, 1000);
        }
        
        // å¤åˆ¶ä¸‹è½½é“¾æ¥
        function copyDownloadLink(os) {
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const downloadLinks = {
                windows: baseUrl + 'crawler/arcaea_crawler.py',
                macos: baseUrl + 'crawler/arcaea_crawler.py',
                linux: baseUrl + 'crawler/arcaea_crawler.py'
            };
            
            // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(downloadLinks[os]).then(() => {
                showNotification('ä¸‹è½½é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = downloadLinks[os];
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('ä¸‹è½½é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }
        
        // æ˜¾ç¤ºå¼€å‘è€…æŒ‡å—
        function showDevGuide() {
            const devModal = document.createElement('div');
            devModal.className = 'confirm-dialog dev-dialog';
            devModal.innerHTML = `
                <div class="confirm-content">
                    <h3>å¼€å‘è€…æŒ‡å—</h3>
                    <div class="dev-content">
                        <h4>å¦‚ä½•æ„å»ºè‡ªå·±çš„Arcaeaçˆ¬è™«</h4>
                        <div class="dev-steps">
                            <div class="dev-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>é€‰æ‹©æŠ€æœ¯æ ˆ</h5>
                                    <p>æ¨èä½¿ç”¨Python + requests + BeautifulSoupï¼Œæˆ–Node.js + axios + cheerio</p>
                                </div>
                            </div>
                            <div class="dev-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>åˆ†æAPI</h5>
                                    <p>ç ”ç©¶Arcaea Onlineçš„APIæ¥å£å’Œæ•°æ®æ ¼å¼</p>
                                </div>
                            </div>
                            <div class="dev-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>å®ç°ç™»å½•</h5>
                                    <p>å¤„ç†ç™»å½•è®¤è¯ï¼Œè·å–session tokenæˆ–API key</p>
                                </div>
                            </div>
                            <div class="dev-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>è·å–æ•°æ®</h5>
                                    <p>è°ƒç”¨APIè·å–B30å’ŒR10æ•°æ®ï¼Œè§£æJSONæˆ–HTMLå“åº”</p>
                                </div>
                            </div>
                            <div class="dev-step">
                                <div class="step-number">5</div>
                                <div class="step-content">
                                    <h5>æ ¼å¼åŒ–è¾“å‡º</h5>
                                    <p>å°†æ•°æ®æ ¼å¼åŒ–ä¸ºPTTè®¡ç®—å™¨å¯è¯†åˆ«çš„æ ¼å¼ï¼Œè‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="code-example">
                            <h5>Pythonä»£ç ç¤ºä¾‹</h5>
                            <pre><code># Arcaeaçˆ¬è™«ç¤ºä¾‹
import requests
import json
import pyperclip

def get_arcaea_data(username, password):
    # ç™»å½•è·å–token
    login_data = {"username": username, "password": password}
    response = requests.post("https://arcaea.online/api/login", json=login_data)
    token = response.json()["token"]
    
    # è·å–B30æ•°æ®
    headers = {"Authorization": f"Bearer {token}"}
    response = requests.get("https://arcaea.online/api/best30", headers=headers)
    b30_data = response.json()["data"]
    
    # æ ¼å¼åŒ–æ•°æ®
    formatted_data = format_for_ptt_calculator(b30_data)
    
    # å¤åˆ¶åˆ°å‰ªè´´æ¿
    pyperclip.copy(formatted_data)
    print("æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç²˜è´´åˆ°PTTè®¡ç®—å™¨")
    
def format_for_ptt_calculator(data):
    # å®ç°æ•°æ®æ ¼å¼åŒ–é€»è¾‘
    pass</code></pre>
                        </div>
                        
                        <div class="legal-note">
                            <h6>âš ï¸ æ³•å¾‹å’Œé“å¾·æé†’</h6>
                            <p>è¯·ç¡®ä¿æ‚¨çš„çˆ¬è™«ç¨‹åºï¼š</p>
                            <ul>
                                <li>éµå®ˆArcaea Onlineçš„æœåŠ¡æ¡æ¬¾</li>
                                <li>ä¸è¦è¿‡äºé¢‘ç¹åœ°è¯·æ±‚æœåŠ¡å™¨</li>
                                <li>ä¸è¦åˆ†å‘ä»–äººçš„ç§äººæ•°æ®</li>
                                <li>ä»…ç”¨äºä¸ªäººä½¿ç”¨ï¼Œä¸è¦ç”¨äºå•†ä¸šç›®çš„</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm-no" onclick="closeDevModal()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.appendChild(devModal);
        }
        
        // å…³é—­ä¸‹è½½æ¨¡æ€æ¡†
        function closeDownloadModal() {
            const modal = document.querySelector('.download-dialog');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // å…³é—­å¼€å‘è€…æŒ‡å—æ¨¡æ€æ¡†
        function closeDevModal() {
            const modal = document.querySelector('.dev-dialog');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // å…³é—­çˆ¬è™«æ•°æ®å¯¼å…¥æ¨¡æ€æ¡†
        function closeCrawlerModal() {
            const modal = document.querySelector('.confirm-dialog');
            if (modal && modal.querySelector('.crawler-modal')) {
                document.body.removeChild(modal);
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSongConstants();
            
            // æ·»åŠ åˆ°B30æŒ‰é’®
            const addToB30Btn = document.getElementById('add-to-b30-btn');
            if (addToB30Btn) {
                addToB30Btn.addEventListener('click', function() {
                    console.log('æ·»åŠ åˆ°B30æŒ‰é’®è¢«ç‚¹å‡»');
                    addSongToList('b30');
                });
            }
            
            // æ¸…ç©ºB30æŒ‰é’®
            const clearB30Btn = document.getElementById('clear-b30-btn');
            if (clearB30Btn) {
                clearB30Btn.addEventListener('click', function() {
                    console.log('æ¸…ç©ºB30æŒ‰é’®è¢«ç‚¹å‡»');
                    clearList('b30');
                });
            }
            
            // æ·»åŠ åˆ°R10æŒ‰é’®
            const addToR10Btn = document.getElementById('add-to-r10-btn');
            if (addToR10Btn) {
                addToR10Btn.addEventListener('click', function() {
                    console.log('æ·»åŠ åˆ°R10æŒ‰é’®è¢«ç‚¹å‡»');
                    addSongToList('r10');
                });
            }
            
            // æ¸…ç©ºR10æŒ‰é’®
            const clearR10Btn = document.getElementById('clear-r10-btn');
            if (clearR10Btn) {
                clearR10Btn.addEventListener('click', function() {
                    console.log('æ¸…ç©ºR10æŒ‰é’®è¢«ç‚¹å‡»');
                    clearList('r10');
                });
            }
        });
        
        // éšè—æœç´¢ç»“æœå’Œéš¾åº¦ä¸‹æ‹‰åˆ—è¡¨å½“ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶
        document.addEventListener('click', function(event) {
            // B30ç›¸å…³
            const b30SearchContainer = document.getElementById('b30-song-search').parentNode;
            const b30DifficultyContainer = document.getElementById('b30-difficulty-input').parentNode;
            
            if (!b30SearchContainer.contains(event.target)) {
                document.getElementById('b30-search-results').innerHTML = '';
            }
            
            if (!b30DifficultyContainer.contains(event.target)) {
                document.getElementById('b30-difficulty-results').style.display = 'none';
            }
            
            // R10ç›¸å…³
            const r10SearchContainer = document.getElementById('r10-song-search').parentNode;
            const r10DifficultyContainer = document.getElementById('r10-difficulty-input').parentNode;
            
            if (!r10SearchContainer.contains(event.target)) {
                document.getElementById('r10-search-results').innerHTML = '';
            }
            
            if (!r10DifficultyContainer.contains(event.target)) {
                document.getElementById('r10-difficulty-results').style.display = 'none';
            }
        });
    </script>
</body>
    <style>
        /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirm-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .confirm-content.crawler-modal {
            text-align: left;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .confirm-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .confirm-content p {
            margin-bottom: 20px;
            color: #555;
        }
        
        .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .confirm-yes {
            background-color: #e74c3c;
            color: white;
        }
        
        .confirm-yes:hover {
            background-color: #c0392b;
        }
        
        .confirm-no {
            background-color: #95a5a6;
            color: white;
        }
        
        .confirm-no:hover {
            background-color: #7f8c8d;
        }
        
        .download-steps {
            margin: 15px 0;
        }
        
        .download-steps h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        
        .download-steps ol, .download-steps ul {
            margin: 0 0 15px 0;
            padding-left: 20px;
        }
        
        .download-steps li {
            margin-bottom: 8px;
            font-size: 13px;
            color: #555;
            line-height: 1.4;
        }
        
        .demo-note {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #ffc107;
            margin-top: 15px;
        }
        
        .demo-note p {
            margin: 5px 0;
            font-size: 13px;
            color: #856404;
        }
        
        .demo-note a {
            color: #667eea;
            text-decoration: underline;
        }
        
        .dev-content {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .dev-steps {
            margin: 15px 0;
        }
        
        .dev-step {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        
        .code-example {
            margin: 20px 0;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }
        
        .code-example h5 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        
        .code-example pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .legal-note {
            background: #f8d7da;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #dc3545;
            margin-top: 15px;
        }
        
        .legal-note h6 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #721c24;
        }
        
        .legal-note p {
            margin: 5px 0;
            font-size: 13px;
            color: #721c24;
        }
        
        .legal-note ul {
            margin: 10px 0 0 0;
            padding-left: 18px;
        }
        
        .legal-note li {
            margin-bottom: 5px;
            font-size: 12px;
            color: #721c24;
        }
        
        .download-file-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #2196f3;
            margin-bottom: 15px;
        }
        
        .download-file-info h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #1976d2;
        }
        
        .download-file-info p {
            margin: 5px 0;
            font-size: 13px;
            color: #333;
        }
        
        .download-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .download-file-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .download-file-btn:hover {
            background: #218838;
        }
        
        .download-file-btn::before {
            content: "â¬‡";
            font-size: 14px;
        }
        
        .security-note {
            background: #d4edda;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #28a745;
            margin-top: 15px;
        }
        
        .security-note h6 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #155724;
        }
        
        .security-note p {
            margin: 5px 0;
            font-size: 13px;
            color: #155724;
        }
        
        /* é€šçŸ¥æ¶ˆæ¯æ ·å¼ */
        .notification, .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* çˆ¬è™«æ¨¡æ€æ¡†æ ·å¼ */
        .crawler-modal {
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .crawler-method-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .crawler-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .crawler-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .crawler-method {
            display: none;
        }
        
        .crawler-method.active {
            display: block;
        }
        
        .crawler-data-input {
            width: 100%;
            height: 200px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        
        .crawler-tools {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .tool-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tool-card h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }
        
        .tool-card p {
            margin: 0 0 12px 0;
            color: #666;
            font-size: 14px;
        }
        
        .tool-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .tool-btn:hover {
            background: #5a67d8;
        }
        
        .tutorial-steps {
            margin-top: 20px;
        }
        
        .step {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step-content h5 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #333;
        }
        
        .step-content p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        
        .data-format-examples {
            margin-top: 10px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
        }
        
        .data-format-examples h6 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        
        .format-example {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        .format-example:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .format-example strong {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #555;
        }
        
        .format-example code {
            display: block;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #444;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .extension-steps, .crawler-usage {
            margin-top: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        
        .extension-steps h5, .crawler-usage h5 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        
        .extension-steps ol, .crawler-usage ol {
            margin: 0 0 15px 0;
            padding-left: 20px;
        }
        
        .extension-steps li, .crawler-usage li {
            margin-bottom: 8px;
            font-size: 13px;
            color: #555;
            line-height: 1.4;
        }
        
        .extension-steps li:last-child, .crawler-usage li:last-child {
            margin-bottom: 0;
        }
        
        .tips {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }
        
        .tips h6 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #856404;
        }
        
        .tips ul {
            margin: 0;
            padding-left: 18px;
        }
        
        .tips li {
            margin-bottom: 5px;
            font-size: 12px;
            color: #856404;
        }
        
        .tips li:last-child {
            margin-bottom: 0;
        }
        
        .extension-info {
            margin: 20px 0;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .info-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .info-text h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #333;
        }
        
        .info-text p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        
        .crawler-downloads {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .download-card {
            flex: 1;
            min-width: 150px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .os-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .download-card h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #333;
        }
        
        .download-card p {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #666;
        }
        
        .download-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
            width: 100%;
        }
        
        .download-btn:hover {
            background: #219653;
        }
        
        .crawler-notes {
            margin-top: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .crawler-notes h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        
        .crawler-notes ol {
            margin: 0 0 15px 0;
            padding-left: 20px;
        }
        
        .crawler-notes li {
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .warning {
            color: #e74c3c;
            font-size: 13px;
            font-style: italic;
            margin-top: 10px;
        }
    </style>
</html>